<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Rotation Manager - Cloud Sync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            font-size: 13px;
            overflow-y: scroll;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: white;
            color: #333;
            padding: 20px 30px;
            text-align: center;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 5px;
            color: #667eea;
            font-weight: 700;
        }

        .header p {
            opacity: 0.7;
            font-size: 13px;
            color: #666;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0 10px;
            scrollbar-gutter: stable;
        }

        .nav-tab {
            flex: 0 0 auto;
            padding: 14px 20px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #999;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .nav-tab .tab-icon {
            font-size: 16px;
            opacity: 1;
            transition: all 0.2s;
            color: inherit;
        }

        .nav-tab:hover {
            background: #f8f9fa;
            color: #666;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background: white;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
            font-weight: 700;
        }

        .player-input-group {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        .player-input {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .player-input label {
            width: 80px;
            font-weight: 600;
            color: #555;
            font-size: 13px;
        }

        .player-input input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            transition: border-color 0.3s;
        }

        .player-input input:focus {
            outline: none;
            border-color: #667eea;
        }

        .player-input input:disabled {
            background-color: #f8f9fa;
            color: #495057;
            cursor: not-allowed;
            border-color: #e9ecef;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #5568d3;
            color: white;
        }

        .btn-success:hover {
            background: #4557bd;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(85, 104, 211, 0.4);
        }

        .btn-danger {
            background: #e85555;
            color: white;
        }

        .btn-danger:hover {
            background: #dc3545;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .sets-container {
            display: grid;
            gap: 20px;
        }

        .set-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #6c757d;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .set-card:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.12);
        }

        .set-card h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .set-card h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
        }

        .bench-selection {
            margin: 15px 0;
        }

        .bench-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }

        .bench-option {
            padding: 10px 18px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 13px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .bench-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .bench-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .bench-option.ineligible {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .bench-option.rank-1 {
            border-color: #667eea;
            background: #e8ecff;
        }

        .bench-option.rank-1.selected {
            background: #667eea;
            color: white;
        }

        .bench-option.rank-2 {
            border-color: #91a0f5;
            background: #f3f5ff;
        }

        .bench-option.rank-2.selected {
            background: #91a0f5;
            color: white;
        }

        .bench-option.rank-3 {
            border-color: #b0b0b0;
            background: #f5f5f5;
        }

        .bench-option.rank-3.selected {
            background: #808080;
            color: white;
        }

        .bench-option.rank-4 {
            border-color: #c0c0c0;
            background: #f8f8f8;
        }

        .bench-option.rank-4.selected {
            background: #999999;
            color: white;
        }

        .bench-option.rank-5 {
            border-color: #d0d0d0;
            background: #fafafa;
        }

        .bench-option.rank-5.selected {
            background: #b0b0b0;
            color: white;
        }

        .rank-badge {
            display: inline-block;
            background: #808080;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .rank-1 .rank-badge {
            background: #667eea;
            color: white;
        }

        .rank-2 .rank-badge {
            background: #91a0f5;
            color: white;
        }

        .rank-3 .rank-badge {
            background: #808080;
            color: white;
        }

        .rank-4 .rank-badge {
            background: #999999;
            color: white;
        }

        .rank-5 .rank-badge {
            background: #b0b0b0;
            color: white;
        }

        .bench-option.selected .rank-badge {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .court-display {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 5px;
        }

        .court-display h4 {
            color: #555;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .players-on-court {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .player-chip {
            padding: 8px 16px;
            background: #e7f3ff;
            border: 2px solid #667eea;
            border-radius: 20px;
            color: #667eea;
            font-weight: 600;
        }

        .winner-selection {
            margin: 15px 0;
        }

        .winner-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .winner-option {
            flex: 1;
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 13px;
        }

        .winner-option:hover {
            border-color: #667eea;
        }

        .winner-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 0;
            font-size: 14px;
            font-weight: 500;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-success {
            background: #e9ecef;
            color: #495057;
            border: 1px solid #ced4da;
            font-weight: 600;
            font-size: 15px;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .stats-table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .stats-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 0;
            background: white;
            font-size: 13px;
            table-layout: fixed;
        }

        .stats-table th,
        .stats-table td {
            padding: 8px 10px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            color: #666;
        }

        .stats-table th {
            background: #f5f5f5;
            color: #666;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .stats-table tbody tr {
            transition: background 0.15s;
            background: white;
        }

        .stats-table tbody tr:last-child td {
            border-bottom: none;
        }

        .stats-table tbody tr:hover td {
            background: #f8f9ff;
        }

        /* Rank column - not sticky */
        .stats-table th:nth-child(1),
        .stats-table td:nth-child(1) {
            width: 8%;
            min-width: 50px;
            font-weight: 700;
            color: #333;
        }

        .stats-table td:nth-child(1) {
            font-size: 0.95em;
        }

        /* FlashScore-style blue badges for rank numbers */
        .stats-table .rank-number {
            display: inline-block;
            min-width: 22px;
            height: 22px;
            line-height: 22px;
            text-align: center;
            font-weight: 700;
            font-size: 10px;
            border-radius: 3px;
        }

        /* Add dot after the number */
        .stats-table .rank-number::after {
            content: '.';
        }

        /* Blue badges for top 5 positions - purple/blue gradient from dark to light */
        .stats-table tbody tr:nth-child(1) .rank-number {
            background: #5568d3;
            color: white;
        }

        .stats-table tbody tr:nth-child(2) .rank-number {
            background: #667eea;
            color: white;
        }

        .stats-table tbody tr:nth-child(3) .rank-number {
            background: #7b8ff0;
            color: white;
        }

        .stats-table tbody tr:nth-child(4) .rank-number {
            background: #91a0f5;
            color: white;
        }

        .stats-table tbody tr:nth-child(5) .rank-number {
            background: #a7b1fa;
            color: white;
        }

        /* FlashScore-style sticky PLAYER column */
        .stats-table th:nth-child(2),
        .stats-table td:nth-child(2) {
            width: 30%;
            min-width: 120px;
            text-align: left;
            padding-left: 15px;
            font-weight: 400;
            position: sticky;
            left: 0;
            z-index: 5;
            background: white;
            border-right: 2px solid #e0e0e0;
            box-shadow: 4px 0 8px -2px rgba(0, 0, 0, 0.1);
        }

        .stats-table th:nth-child(2) {
            background: #f5f5f5;
            z-index: 15;
            font-weight: 600;
            box-shadow: 4px 0 8px -2px rgba(0, 0, 0, 0.1);
        }

        .stats-table tbody tr:hover td:nth-child(2) {
            background: #f0f2ff;
        }

        /* Set columns */
        .stats-table th:nth-child(3),
        .stats-table th:nth-child(4),
        .stats-table th:nth-child(5),
        .stats-table th:nth-child(6) {
            width: 10%;
        }

        .stats-table td:nth-child(3),
        .stats-table td:nth-child(4),
        .stats-table td:nth-child(5),
        .stats-table td:nth-child(6) {
            width: 10%;
            color: #333;
        }

        /* Total column */
        .stats-table th:nth-child(7),
        .stats-table td:nth-child(7) {
            width: 12%;
            font-weight: 600;
            color: #333;
        }

        /* Points column - darker black with semi-bold like FlashScore */
        .stats-table th:nth-child(8),
        .stats-table td:nth-child(8) {
            width: 20%;
        }

        .stats-table td:nth-child(8) {
            font-weight: 600;
            color: #000;
            font-size: 13px;
        }

        .week-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .week-card:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.12);
        }

        .week-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .week-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .week-card-header h3 {
            margin: 0;
        }

        .delete-week-btn {
            background: #e85555;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .delete-week-btn:hover {
            background: #dc3545;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);
        }

        .week-sets {
            display: grid;
            gap: 12px;
        }

        .week-set {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .week-set-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .winner-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }

        .export-import-section {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .manual-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            margin-top: 10px;
            background: white;
            cursor: pointer;
        }

        .manual-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .manual-winner-grid {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }

        .manual-winner-option {
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .manual-winner-option:hover {
            border-color: #28a745;
        }

        .manual-winner-option.selected {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .team-builder {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 5px;
        }

        .team-builder h4 {
            color: #555;
            margin-bottom: 15px;
        }

        .teams-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .team-box {
            border: 2px solid #6c757d;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }

        .team-box h5 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .player-dropzone {
            min-height: 80px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            padding: 10px;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .player-dropzone.has-players {
            border-style: solid;
            border-color: #6c757d;
        }

        .available-players {
            margin-top: 15px;
        }

        .available-players h5 {
            color: #555;
            margin-bottom: 10px;
        }

        .player-draggable {
            padding: 8px 16px;
            background: #e7f3ff;
            border: 2px solid #667eea;
            border-radius: 20px;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            display: inline-block;
            margin: 5px;
            user-select: none;
            transition: all 0.2s;
            font-size: 13px;
        }

        .player-draggable:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .player-draggable.in-team {
            background: #667eea;
            color: white;
            cursor: pointer;
        }

        .team-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .manual-winner-option.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .no-data-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header p {
                font-size: 12px;
            }

            .nav-tab {
                font-size: 11px;
                padding: 12px 12px;
                white-space: nowrap;
                gap: 4px;
            }

            .nav-tab .tab-icon {
                font-size: 14px;
            }

            .tab-content {
                padding: 15px;
            }

            .section-title {
                font-size: 1.2em;
            }

            .player-input {
                flex-direction: column;
                align-items: stretch;
            }

            .player-input label {
                width: 100%;
                margin-bottom: 5px;
            }

            .btn {
                padding: 12px 16px;
                font-size: 0.9em;
                width: 100%;
                margin-bottom: 10px;
            }

            .sets-container {
                gap: 15px;
            }

            .set-card {
                padding: 15px;
            }

            .bench-options {
                flex-direction: column;
            }

            .bench-option {
                width: 100%;
                text-align: left;
            }

            .winner-options {
                flex-direction: column;
            }

            .winner-option {
                width: 100%;
            }

            .teams-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .team-box {
                padding: 10px;
            }

            .stats-table {
                font-size: 0.85em;
            }

            .stats-table th,
            .stats-table td {
                padding: 10px 8px;
            }

            .stats-table th {
                font-size: 0.75em;
            }

            /* Make table scrollable on mobile */
            .stats-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Rank column - not sticky on mobile */
            .stats-table th:nth-child(1),
            .stats-table td:nth-child(1) {
                min-width: 40px !important;
            }

            /* Enhanced sticky PLAYER column for mobile */
            .stats-table th:nth-child(2),
            .stats-table td:nth-child(2) {
                position: sticky !important;
                left: 0 !important;
                z-index: 5 !important;
                background: white !important;
                border-right: 2px solid #e0e0e0 !important;
                box-shadow: 4px 0 8px -2px rgba(0, 0, 0, 0.1) !important;
                font-weight: 500 !important;
                min-width: 100px !important;
                padding-left: 12px !important;
            }

            .stats-table th:nth-child(2) {
                background: #f5f5f5 !important;
                z-index: 15 !important;
                font-weight: 600 !important;
            }

            .stats-table tbody tr:hover td:nth-child(2) {
                background: #f0f2ff !important;
            }

            .week-card {
                padding: 15px;
            }

            .export-import-section {
                flex-direction: column;
            }

            .export-import-section .btn {
                width: 100%;
            }

            /* Improve touch targets */
            .player-draggable {
                padding: 12px 20px;
                margin: 8px 5px;
                font-size: 1em;
            }

            .bench-option {
                padding: 15px;
                font-size: 1em;
                min-height: 50px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .rank-badge {
                font-size: 0.8em;
            }

            .stats-table thead th:nth-child(2),
            .stats-table tbody td:nth-child(2) {
                position: sticky;
                left: 8%;
                z-index: 4;
            }
            
            .stats-table thead th:nth-child(2) {
                background: #f5f5f5;
                z-index: 14;
            }
            
            .stats-table tbody td:nth-child(2) {
                background: white;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.3em;
            }

            .nav-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .nav-tab {
                font-size: 0.7em;
                padding: 10px 8px;
                white-space: nowrap;
            }

            .stats-table {
                font-size: 0.75em;
            }

            .bench-visual-cell {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 data-translate="app_title">üéæ Tennis Rotation Manager</h1>
                    <p data-translate="app_subtitle">Fair doubles rotation for 5 players</p>
                </div>
                <div id="langToggle" style="display: flex; align-items: center; gap: 8px; background: #2d3748; padding: 6px; border-radius: 25px; cursor: pointer;">
                    <span class="lang-option" data-lang="en" style="padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px; transition: all 0.3s ease; color: #fff;">EN</span>
                    <span class="lang-option" data-lang="ro" style="padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px; transition: all 0.3s ease; color: #a0aec0;">RO</span>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="stats">
                <span class="tab-icon">‚ñ§</span>
                <span class="tab-text" data-translate="tab_stats">Statistics</span>
            </button>
            <button class="nav-tab" data-tab="week">
                <span class="tab-icon">‚óâ</span>
                <span class="tab-text" data-translate="tab_week">Current Week</span>
            </button>
            <button class="nav-tab" data-tab="faq">
                <span class="tab-icon">?</span>
                <span class="tab-text" data-translate="tab_faq">FAQ</span>
            </button>
            <button class="nav-tab" data-tab="history">
                <span class="tab-icon">‚ò∞</span>
                <span class="tab-text" data-translate="tab_history">History</span>
            </button>
            <button class="nav-tab" data-tab="setup">
                <span class="tab-icon">‚öô</span>
                <span class="tab-text" data-translate="tab_setup">Setup</span>
            </button>
            <button class="nav-tab" data-tab="manual">
                <span class="tab-icon">‚úé</span>
                <span class="tab-text" data-translate="tab_manual">Historical Data</span>
            </button>
            <button class="nav-tab" data-tab="data">
                <span class="tab-icon">‚ó´</span>
                <span class="tab-text" data-translate="tab_data">Data</span>
            </button>
        </div>

        <!-- Setup Tab -->
        <div id="setup" class="tab-content">
            <div class="section">
                <h2 class="section-title" data-translate="section_setup">Player Setup</h2>
                <div id="setupContainer"></div>
            </div>
        </div>

        <!-- Current Week Tab -->
        <div id="week" class="tab-content">
            <div class="section">
                <h2 class="section-title" data-translate="section_weekly_match">Weekly Match</h2>
                
                <!-- Week Status Card -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #667eea;">
                    <div id="weekStatus"></div>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="startNewWeek()" id="newWeekBtn"><span data-translate="btn_start_week">Start New Week</span></button>
                        <button class="btn btn-danger" onclick="resetCurrentWeekNoConfirm()" id="resetWeekBtn" style="display: none;"><span data-translate="btn_reset_week">üóëÔ∏è Clear & Restart Week</span></button>
                    </div>
                </div>
                
                <div id="setsContainer"></div>
            </div>
        </div>

        <!-- Manual Historical Data Tab -->
        <div id="manual" class="tab-content">
            <div class="section">
                <h2 class="section-title" data-translate="section_historical_data">Add Historical Week Data</h2>
                <p style="margin-bottom: 20px; color: #666;" data-translate="historical_data_desc">
                    Use this form to manually enter data from previous weeks. This will update player statistics and improve future recommendations.
                </p>
                <div id="manualContainer"></div>
            </div>
        </div>

        <!-- Statistics Tab -->
        <div id="stats" class="tab-content active">
            <div class="section">
                <h2 class="section-title" data-translate="section_statistics">Bench Statistics</h2>
                <div id="statsContainer"></div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div class="section">
                <h2 class="section-title" data-translate="section_history">Match History</h2>
                <div id="historyContainer"></div>
            </div>
        </div>

        <!-- Data Tab -->
        <!-- FAQ Tab -->
        <div id="faq" class="tab-content">
            <div class="section">
                <h2 class="section-title" data-translate="section_faq">Frequently Asked Questions (FAQ)</h2>
                <div id="faqContainer"></div>
            </div>
        </div>

        <div id="data" class="tab-content">
            <div class="section">
                <h2 class="section-title" data-translate="section_data_management">Data Management</h2>
                <p style="margin-bottom: 20px; color: #666;" data-translate="data_management_desc">
                    Your data is automatically saved in your browser's IndexedDB. Use these tools to backup or restore your data.
                </p>
                <div id="dataContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // ==============================================
        // SUPABASE CONFIGURATION - CLOUD SYNC
        // ==============================================
        //
        // INSTRUCTIONS TO ENABLE CLOUD SYNC:
        //
        // 1. Create a Supabase project at https://supabase.com
        // 2. In SQL Editor, run this to create the table:
        //
        //    CREATE TABLE tennis_data (
        //      id BIGSERIAL PRIMARY KEY,
        //      data_type TEXT NOT NULL UNIQUE,
        //      content JSONB,
        //      updated_at TIMESTAMPTZ DEFAULT NOW()
        //    );
        //
        //    ALTER TABLE tennis_data ENABLE ROW LEVEL SECURITY;
        //
        //    CREATE POLICY "Enable all access for all users" ON tennis_data
        //      FOR ALL USING (true) WITH CHECK (true);
        //
        //    CREATE INDEX idx_tennis_data_type ON tennis_data(data_type);
        //
        // 3. Go to Settings ‚Üí API and copy:
        //    - Project URL (SUPABASE_URL below)
        //    - anon public key (SUPABASE_KEY below)
        //
        // 4. Replace the values below with your credentials
        // 5. Set SUPABASE_ENABLED = true
        //
        // ==============================================

        const SUPABASE_URL = 'https://qmvuknszmuhmwareqepu.supabase.co'; // e.g., 'https://xxxxxxxxxxxxx.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtdnVrbnN6bXVobXdhcmVxZXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MTc3NzksImV4cCI6MjA4MTk5Mzc3OX0.oYA55gHmXChQdgo-5JMUrCIJ1LU52vtAaIWl1otTo00'; // Your anon/public key (safe to expose publicly)

        // Set this to true once you've added your Supabase credentials above
        const SUPABASE_ENABLED = true; // Change to true after adding credentials
        
        // ==============================================
        // SUPABASE CLIENT (Simple fetch-based)
        // ==============================================
        
        class SupabaseClient {
            constructor(url, key) {
                this.url = url;
                this.key = key;
            }
            
            async query(table, method = 'GET', body = null, id = null) {
                const endpoint = id 
                    ? `${this.url}/rest/v1/${table}?id=eq.${id}`
                    : `${this.url}/rest/v1/${table}`;
                
                const options = {
                    method: method,
                    headers: {
                        'apikey': this.key,
                        'Authorization': `Bearer ${this.key}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    }
                };
                
                if (body && (method === 'POST' || method === 'PATCH')) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(endpoint, options);
                if (!response.ok) {
                    throw new Error(`Supabase error: ${response.statusText}`);
                }
                return response.json();
            }
            
            async getByType(type) {
                const endpoint = `${this.url}/rest/v1/tennis_data?data_type=eq.${type}`;
                const response = await fetch(endpoint, {
                    headers: {
                        'apikey': this.key,
                        'Authorization': `Bearer ${this.key}`
                    }
                });
                const data = await response.json();
                return data.length > 0 ? data[0].content : null;
            }
            
            async upsertByType(type, content) {
                // First, try to get existing
                const existing = await this.getByType(type);
                
                if (existing) {
                    // Update existing
                    const endpoint = `${this.url}/rest/v1/tennis_data?data_type=eq.${type}`;
                    await fetch(endpoint, {
                        method: 'PATCH',
                        headers: {
                            'apikey': this.key,
                            'Authorization': `Bearer ${this.key}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            content: content,
                            updated_at: new Date().toISOString()
                        })
                    });
                } else {
                    // Insert new
                    const endpoint = `${this.url}/rest/v1/tennis_data`;
                    await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'apikey': this.key,
                            'Authorization': `Bearer ${this.key}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            data_type: type,
                            content: content,
                            updated_at: new Date().toISOString()
                        })
                    });
                }
            }
            
            async getAllWeeks() {
                const weeks = await this.getByType('weeks');
                // Ensure we always return an array
                if (!weeks) return [];
                if (Array.isArray(weeks)) return weeks;
                // If it's a single object somehow, wrap it in an array
                return [weeks];
            }
            
            async saveWeeks(weeksArray) {
                await this.upsertByType('weeks', weeksArray);
            }
        }
        
        // Initialize Supabase client (will show error if not configured)
        let supabase = null;
        if (SUPABASE_ENABLED) {
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
                console.error('‚ö†Ô∏è Supabase credentials not configured! Please update SUPABASE_URL and SUPABASE_KEY in the code.');
            } else {
                supabase = new SupabaseClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('‚úÖ Supabase client initialized');
            }
        } else {
            console.log('‚ÑπÔ∏è Supabase disabled - using local IndexedDB storage');
        }

        // Global error handler to prevent console spam
        window.addEventListener('error', function(e) {
            // Silently log errors without showing to user
            console.warn('Caught error:', e.message);
            e.preventDefault();
            return true;
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.warn('Caught promise rejection:', e.reason);
            e.preventDefault();
        });

        // Database management
        let db;
        const DB_NAME = 'TennisRotationDB';
        const DB_VERSION = 1;

        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                try {
                    // Check if IndexedDB is available
                    if (!window.indexedDB) {
                        console.error('IndexedDB not supported');
                        reject(new Error('IndexedDB not supported'));
                        return;
                    }

                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onerror = (event) => {
                        console.error('Database error:', event);
                        reject(new Error('Failed to open database'));
                    };

                    request.onsuccess = (event) => {
                        db = event.target.result;
                        
                        // Add error handler for database
                        db.onerror = (event) => {
                            console.error('Database error:', event);
                        };
                        
                        console.log('Database initialized successfully');
                        resolve(db);
                    };

                    request.onupgradeneeded = (event) => {
                        try {
                            db = event.target.result;
                            
                            if (!db.objectStoreNames.contains('players')) {
                                db.createObjectStore('players', { keyPath: 'id' });
                            }
                            
                            if (!db.objectStoreNames.contains('weeks')) {
                                db.createObjectStore('weeks', { keyPath: 'weekNumber' });
                            }
                            
                            if (!db.objectStoreNames.contains('currentWeek')) {
                                db.createObjectStore('currentWeek', { keyPath: 'id' });
                            }
                            
                            console.log('Database schema created');
                        } catch (err) {
                            console.error('Error creating database schema:', err);
                            reject(err);
                        }
                    };

                    request.onblocked = () => {
                        console.warn('Database upgrade blocked by another tab');
                    };

                } catch (err) {
                    console.error('Error initializing database:', err);
                    reject(err);
                }
            });
        }

        // Database operations - Unified interface for both Supabase and IndexedDB
        async function saveToStore(storeName, data) {
            try {
                if (SUPABASE_ENABLED && supabase) {
                    // Special handling for weeks - store as array in Supabase
                    if (storeName === 'weeks') {
                        // Get existing weeks array
                        const existingWeeks = await supabase.getAllWeeks();
                        // Find if this week already exists
                        const weekIndex = existingWeeks.findIndex(w => w.weekNumber === data.weekNumber);

                        if (weekIndex >= 0) {
                            // Update existing week
                            existingWeeks[weekIndex] = data;
                        } else {
                            // Add new week
                            existingWeeks.push(data);
                        }

                        // Save the entire weeks array
                        await supabase.saveWeeks(existingWeeks);
                        console.log(`‚úÖ Saved week ${data.weekNumber} to Supabase`);
                    } else {
                        // Save other data types normally
                        await supabase.upsertByType(storeName, data);
                        console.log(`‚úÖ Saved to Supabase: ${storeName}`);
                    }
                } else {
                    // Save to IndexedDB (fallback)
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    await store.put(data);
                    return await new Promise((resolve, reject) => {
                        tx.oncomplete = () => resolve(true);
                        tx.onerror = () => reject(tx.error);
                    });
                }
            } catch (error) {
                console.error('Error saving to store:', storeName, error);
                throw error;
            }
        }

        async function getFromStore(storeName, key) {
            try {
                if (SUPABASE_ENABLED && supabase) {
                    // Get from Supabase
                    return await supabase.getByType(storeName);
                } else {
                    // Get from IndexedDB (fallback)
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    return new Promise((resolve, reject) => {
                        const request = store.get(key);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                }
            } catch (error) {
                console.error('Error getting from store:', storeName, key, error);
                return null;
            }
        }

        async function getAllFromStore(storeName) {
            try {
                if (SUPABASE_ENABLED && supabase) {
                    // Get from Supabase
                    if (storeName === 'weeks') {
                        return await supabase.getAllWeeks();
                    }
                    return [];
                } else {
                    // Get from IndexedDB (fallback)
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    return new Promise((resolve, reject) => {
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = () => reject(request.error);
                    });
                }
            } catch (error) {
                console.error('Error getting all from store:', storeName, error);
                return [];
            }
        }

        async function clearStore(storeName) {
            try {
                if (SUPABASE_ENABLED && supabase) {
                    // Clear in Supabase
                    if (storeName === 'weeks') {
                        // Clear weeks by saving an empty array
                        await supabase.saveWeeks([]);
                        console.log(`‚úÖ Cleared all weeks from Supabase`);
                    } else {
                        await supabase.upsertByType(storeName, null);
                        console.log(`‚úÖ Cleared ${storeName} from Supabase`);
                    }
                } else {
                    // Clear in IndexedDB (fallback)
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    await store.clear();
                    return await new Promise((resolve, reject) => {
                        tx.oncomplete = () => resolve(true);
                        tx.onerror = () => reject(tx.error);
                    });
                }
            } catch (error) {
                console.error('Error clearing store:', storeName, error);
                throw error;
            }
        }

        async function deleteFromStore(storeName, key) {
            try {
                if (SUPABASE_ENABLED && supabase) {
                    // Delete from Supabase
                    if (storeName === 'weeks') {
                        // Get existing weeks array
                        const existingWeeks = await supabase.getAllWeeks();
                        // Filter out the week to delete
                        const updatedWeeks = existingWeeks.filter(w => w.weekNumber !== key);
                        // Save the updated weeks array
                        await supabase.saveWeeks(updatedWeeks);
                        console.log(`‚úÖ Deleted week ${key} from Supabase`);
                    }
                } else {
                    // Delete from IndexedDB (fallback)
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    await store.delete(key);
                    return await new Promise((resolve, reject) => {
                        tx.oncomplete = () => resolve(true);
                        tx.onerror = () => reject(tx.error);
                    });
                }
            } catch (error) {
                console.error('Error deleting from store:', storeName, error);
                throw error;
            }
        }

        // Tab navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
                
                if (targetTab === 'stats') displayStats();
                if (targetTab === 'history') displayHistory();
                if (targetTab === 'week') displayCurrentWeek();
                if (targetTab === 'manual') initManualEntry();
            });
        });

        // Player management
        // Player editing functions
        let originalPlayerValues = [];

        // Generate Historical Data tab content
        async function generateManualEntry() {
            try {
                const players = await loadPlayers();
                
                let html = `
                    <div class="set-card">
                        <h3>${t('week_number')}</h3>
                        <div class="player-input">
                            <label>${t('week_hash')}</label>
                            <input type="number" id="manualWeekNumber" min="1" placeholder="${t('enter_week_number')}" style="max-width: 200px;">
                        </div>
                    </div>

                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">Number of Sets:</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" id="manualSets3Btn" onclick="setManualNumberOfSets(3)">3 Sets</button>
                            <button class="btn btn-secondary" id="manualSets4Btn" onclick="setManualNumberOfSets(4)" style="opacity: 0.6;">4 Sets</button>
                        </div>
                    </div>
                    <div class="sets-container" id="manualSetsContainer">`;

                // Generate 4 sets (4th will be hidden initially)
                for (let i = 1; i <= 4; i++) {
                    html += `
                        <div class="set-card ${i === 4 ? 'manual-set-4' : ''}" style="${i === 4 ? 'display: none;' : ''}" id="manualSetCard${i}">
                            <h3>${t('set')} ${i}</h3>
                            <div class="bench-selection">
                                <h4>${t('bench_player')}:</h4>
                                <select id="manualSet${i}Bench" class="manual-select">
                                    <option value="">${t('select_player')}</option>`;
                    
                    if (players) {
                        players.forEach(player => {
                            html += `<option value="${player.id}">${player.name}</option>`;
                        });
                    }
                    
                    html += `
                                </select>
                            </div>`;

                    // Add "arrived late" checkbox for Set 1
                    if (i === 1) {
                        html += `
                            <div style="margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px;">
                                    <input type="checkbox" id="manualSet1ArrivedLate" style="width: 16px; height: 16px; cursor: pointer;">
                                    <span>Player arrived late (no points)</span>
                                </label>
                            </div>`;
                    }

                    html += `
                            <div class="winner-selection">
                                <h4>${t('winning_team')}:</h4>
                                <div id="manualSet${i}Winners"></div>
                            </div>
                        </div>`;
                }
                
                html += `
                    </div>
                    <div id="manualStatus" style="margin-top: 20px;"></div>
                    <button class="btn btn-success" onclick="saveManualWeek()" style="margin-top: 20px;">
                        ${t('save_historical_week')}
                    </button>`;
                
                const container = document.getElementById('manualContainer');
                if (container) {
                    container.innerHTML = html;
                }
                
                // Re-initialize manual entry after generating HTML
                if (players) {
                    await initManualEntry();
                }
            } catch (error) {
                console.error('Error generating manual entry:', error);
            }
        }
        
        // Generate Data Management tab content
        function generateDataManagement() {
            let html = `
                <div class="export-import-section">
                    <button class="btn btn-success" onclick="exportData()">
                        ${t('export_data_json')}
                    </button>
                    
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">
                        ${t('import_data_json')}
                    </button>
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)" style="display: none;">
                    
                    <button class="btn btn-danger" onclick="clearAllData()">
                        ${t('clear_all_data_btn')}
                    </button>
                </div>

                <div id="dataStatus" style="margin-top: 20px;"></div>`;
            
            const container = document.getElementById('dataContainer');
            if (container) {
                container.innerHTML = html;
            }
        }

        // Generate Setup tab content
        async function generateSetup() {
            try {
                const players = await loadPlayers();
                
                let html = `
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="toggleEditPlayers()" id="editPlayersBtn">${t('edit_players')}</button>
                        <button class="btn btn-success" onclick="savePlayers()" id="savePlayersBtn" style="display: none;">${t('save_players')}</button>
                        <button class="btn btn-secondary" onclick="cancelEditPlayers()" id="cancelEditBtn" style="display: none;">${t('btn_cancel')}</button>
                    </div>
                    
                    <div class="player-input-group">`;
                
                for (let i = 1; i <= 5; i++) {
                    const playerName = players && players[i-1] ? players[i-1].name : '';
                    html += `
                        <div class="player-input">
                            <label>${t('player_label')} ${i}:</label>
                            <input type="text" id="player${i}" placeholder="${t('enter_name')}" disabled value="${playerName}">
                        </div>`;
                }
                
                html += `</div>`;
                
                const container = document.getElementById('setupContainer');
                if (container) {
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error generating setup:', error);
                const container = document.getElementById('setupContainer');
                if (container) {
                    container.innerHTML = '<div class="status-warning">Error loading setup. Please refresh the page.</div>';
                }
            }
        }

        function toggleEditPlayers() {
            // Store original values
            originalPlayerValues = [];
            for (let i = 1; i <= 5; i++) {
                const input = document.getElementById(`player${i}`);
                originalPlayerValues.push(input.value);
                input.disabled = false;
            }

            // Toggle buttons
            document.getElementById('editPlayersBtn').style.display = 'none';
            document.getElementById('savePlayersBtn').style.display = 'inline-block';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
        }

        function cancelEditPlayers() {
            // Restore original values
            for (let i = 1; i <= 5; i++) {
                const input = document.getElementById(`player${i}`);
                input.value = originalPlayerValues[i - 1];
                input.disabled = true;
            }

            // Toggle buttons back
            document.getElementById('editPlayersBtn').style.display = 'inline-block';
            document.getElementById('savePlayersBtn').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        async function savePlayers() {
            try {
                const players = [];
                for (let i = 1; i <= 5; i++) {
                    const name = document.getElementById(`player${i}`).value.trim();
                    if (!name) {
                        alert(t('enter_all_names'));
                        return;
                    }
                    players.push({
                        id: i,
                        name: name,
                        set1Benches: 0,
                        set2Benches: 0,
                        set3Benches: 0,
                        set3Points: 0,
                        set4Benches: 0,
                        set4Points: 0,
                        totalBenches: 0
                    });
                }

                await saveToStore('players', { id: 'playerList', players: players });
                
                // Regenerate setup to reflect saved state
                await generateSetup();
                
                alert(t('players_saved_success'));
            } catch (error) {
                console.error('Error saving players:', error);
                alert(currentLang === 'en' ? 'Error saving players. Please try again.' : 'Eroare la salvarea jucƒÉtorilor. Te rog √ÆncearcƒÉ din nou.');
            }
        }

        async function loadPlayers() {
            try {
                const data = await getFromStore('players', 'playerList');
                if (data && data.players) {
                    data.players.forEach((player, index) => {
                        const input = document.getElementById(`player${index + 1}`);
                        if (input) {
                            input.value = player.name;
                        }
                    });
                    return data.players;
                }
                return null;
            } catch (error) {
                console.error('Error loading players:', error);
                return null;
            }
        }

        // Week management
        async function startNewWeek() {
            try {
                const players = await loadPlayers();
                if (!players) {
                    alert('Please set up players first!');
                    return;
                }

                const weeks = await getAllFromStore('weeks');
                const weekNumber = weeks.length + 1;

                const currentWeek = {
                    id: 'current',
                    weekNumber: weekNumber,
                    numberOfSets: 3, // Can be 3 or 4
                    sets: [
                        { number: 1, bench: null, team1: null, team2: null, winners: null, locked: false, arrivedLate: false },
                        { number: 2, bench: null, team1: null, team2: null, winners: null, locked: false },
                        { number: 3, bench: null, team1: null, team2: null, winners: null, locked: false, set3Duration: 'full' },
                        { number: 4, bench: null, team1: null, team2: null, winners: null, locked: false, set4Duration: 'full', enabled: false }
                    ],
                    completed: false
                };

                await saveToStore('currentWeek', currentWeek);
                await displayCurrentWeek();
            } catch (error) {
                console.error('Error starting new week:', error);
                alert('Error starting new week. Please try again.');
            }
        }

        // Rank eligible players by fairness algorithm
        function rankPlayersByFairness(eligiblePlayers, setNumber, currentWeek = null) {
            const ranked = [...eligiblePlayers].sort((a, b) => {
                // Check who benched earlier TODAY and in which set
                let aBenchedSetNumber = -1;
                let bBenchedSetNumber = -1;
                if (currentWeek) {
                    for (let i = 0; i < setNumber - 1; i++) {
                        if (currentWeek.sets[i].bench === a.id) {
                            aBenchedSetNumber = i + 1; // Store the set number (1-indexed)
                        }
                        if (currentWeek.sets[i].bench === b.id) {
                            bBenchedSetNumber = i + 1;
                        }
                    }
                }
                
                const aBenchedThisWeek = aBenchedSetNumber > 0;
                const bBenchedThisWeek = bBenchedSetNumber > 0;
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // PRIORITY 0 (ABSOLUTE LAST): Players who BENCHED earlier TODAY
                // Latest benched = last priority (position 5), earliest benched = first among benched (position 3)
                // This takes precedence over ALL other factors
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                if (aBenchedThisWeek && !bBenchedThisWeek) return 1;  // A benched = goes after non-benched
                if (bBenchedThisWeek && !aBenchedThisWeek) return -1; // B benched = goes after non-benched
                if (aBenchedThisWeek && bBenchedThisWeek) {
                    // Both benched - latest benched should be LAST
                    // So if A was benched later (higher set number), A should come AFTER B (return positive)
                    return bBenchedSetNumber - aBenchedSetNumber;
                }
                
                // From here on, we only compare players who have NOT been benched this week
                
                // Calculate weighted scores
                const aWeightedScore = (a.set1Benches * 1.0) + (a.set2Benches * 1.0) + (a.set3Points || 0) + (a.set4Points || 0);
                const bWeightedScore = (b.set1Benches * 1.0) + (b.set2Benches * 1.0) + (b.set3Points || 0) + (b.set4Points || 0);
                
                // Check who was a winner in previous set(s) TODAY
                let aWasWinnerThisWeek = false;
                let bWasWinnerThisWeek = false;
                if (currentWeek) {
                    for (let i = 0; i < setNumber - 1; i++) {
                        const set = currentWeek.sets[i];
                        if (set.winners && set.winners.includes(a.id)) {
                            aWasWinnerThisWeek = true;
                        }
                        if (set.winners && set.winners.includes(b.id)) {
                            bWasWinnerThisWeek = true;
                        }
                    }
                }
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // PRIORITY 1: Winner who is 1+ behind another specific player
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // If A is a winner and 1+ behind B specifically, A gets priority over B
                if (aWasWinnerThisWeek && bWeightedScore - aWeightedScore >= 1.0) {
                    return -1; // A (winner) gets priority over B (who is 1+ ahead)
                }
                
                // If B is a winner and 1+ behind A specifically, B gets priority over A
                if (bWasWinnerThisWeek && aWeightedScore - bWeightedScore >= 1.0) {
                    return 1; // B (winner) gets priority over A (who is 1+ ahead)
                }
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // PRIORITY 2: Normal weighted score comparison
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // Lower score = higher priority (more deserving to bench)
                if (aWeightedScore !== bWeightedScore) {
                    return aWeightedScore - bWeightedScore;
                }

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // PRIORITY 2: Set-specific bench count (tiebreaker)
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                if (setNumber === 1 && a.set1Benches !== b.set1Benches) {
                    return a.set1Benches - b.set1Benches;
                } else if (setNumber === 2 && a.set2Benches !== b.set2Benches) {
                    return a.set2Benches - b.set2Benches;
                } else if (setNumber === 3 && a.set3Benches !== b.set3Benches) {
                    return a.set3Benches - b.set3Benches;
                } else if (setNumber === 4 && a.set4Benches !== b.set4Benches) {
                    return a.set4Benches - b.set4Benches;
                }

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // PRIORITY 3: Total benches
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                if (a.totalBenches !== b.totalBenches) {
                    return a.totalBenches - b.totalBenches;
                }

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // PRIORITY 4: Stable sort by ID
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                return a.id - b.id;
            });

            return ranked;
        }

        async function displayCurrentWeek() {
            const currentWeek = await getFromStore('currentWeek', 'current');
            const players = await loadPlayers();

            const newWeekBtn = document.getElementById('newWeekBtn');
            const resetWeekBtn = document.getElementById('resetWeekBtn');

            if (!newWeekBtn || !resetWeekBtn) {
                console.error('Week buttons not found in DOM');
                return;
            }

            if (!currentWeek || currentWeek.completed) {
                document.getElementById('weekStatus').innerHTML = 
                    `<div class="status-info">${t('msg_no_active_week')}</div>`;
                newWeekBtn.disabled = false;
                newWeekBtn.style.display = 'inline-block';
                resetWeekBtn.style.display = 'none';
                document.getElementById('setsContainer').innerHTML = '';
                return;
            }

            newWeekBtn.disabled = true;
            newWeekBtn.style.display = 'none';
            resetWeekBtn.style.display = 'inline-block';
            resetWeekBtn.disabled = false;
            console.log('Reset button should now be visible');
            document.getElementById('weekStatus').innerHTML = 
                `<div class="status-success">${t('msg_week_in_progress', currentWeek.weekNumber)}</div>`;

            // Initialize numberOfSets if it doesn't exist (for backward compatibility)
            if (!currentWeek.numberOfSets) {
                currentWeek.numberOfSets = 3;
            }

            let html = '<div class="sets-container">';

            // Add controls to toggle number of sets (only show after Set 2 is locked)
            if (currentWeek.sets[1] && currentWeek.sets[1].locked) {
                html += `<div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                    <label style="font-weight: 600; margin-bottom: 10px; display: block;">Number of Sets for This Week:</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn ${currentWeek.numberOfSets === 3 ? 'btn-primary' : 'btn-secondary'}"
                            onclick="setNumberOfSets(3)"
                            style="flex: 1; ${currentWeek.numberOfSets === 3 ? '' : 'opacity: 0.6;'}">
                            3 Sets
                        </button>
                        <button class="btn ${currentWeek.numberOfSets === 4 ? 'btn-primary' : 'btn-secondary'}"
                            onclick="setNumberOfSets(4)"
                            style="flex: 1; ${currentWeek.numberOfSets === 4 ? '' : 'opacity: 0.6;'}">
                            4 Sets
                        </button>
                    </div>
                </div>`;
            }

            for (let i = 0; i < currentWeek.numberOfSets; i++) {
                const set = currentWeek.sets[i];

                // Progressive display: Only show Set 2 if Set 1 is locked, only show Set 3 if Set 2 is locked, etc.
                if (i > 0 && !currentWeek.sets[i-1].locked) {
                    // Don't display this set yet - previous set is not locked
                    break;
                }
                
                // Determine categorization for bench selection
                let winnersLastSet = [];
                let previousBencher = null;
                
                if (i > 0) {
                    // Get winners from previous set
                    winnersLastSet = currentWeek.sets[i-1].winners || [];
                    // Get who was benched in previous set
                    previousBencher = currentWeek.sets[i-1].bench;
                }

                html += `<div class="set-card">
                    <h3>${t('set_number', set.number)}</h3>`;

                // Bench selection
                if (!set.locked) {
                    html += `<div class="bench-selection">
                        <h4>${t('select_bench')}</h4>
                        <div class="bench-options">`;

                    // For Set 1, rank all players
                    if (i === 0) {
                        const rankedPlayers = rankPlayersByFairness(players, set.number, currentWeek);
                        
                        rankedPlayers.forEach((player, index) => {
                            const isSelected = set.bench === player.id;
                            const rank = index + 1;
                            const rankClass = `rank-${rank}`;
                            let rankLabel = '';
                            
                            if (rank === 1) rankLabel = t('rank_1st');
                            else if (rank === 2) rankLabel = t('rank_2nd');
                            else if (rank === 3) rankLabel = t('rank_3rd');
                            else if (rank === 4) rankLabel = t('rank_4th');
                            else if (rank === 5) rankLabel = t('rank_5th');
                            
                            html += `<div class="bench-option ${rankClass} ${isSelected ? 'selected' : ''}" 
                                onclick="selectBench(${set.number}, ${player.id})">
                                ${player.name}
                                ${rankLabel ? `<span class="rank-badge">${rankLabel}</span>` : ''}
                            </div>`;
                        });
                    } else {
                        // For Set 2+, rank all players by fairness (respecting benching order)
                        // Get all players benched earlier today (in order)
                        const benchedThisWeek = [];
                        for (let j = 0; j < set.number - 1; j++) {
                            if (currentWeek.sets[j].bench) {
                                benchedThisWeek.push({
                                    playerId: currentWeek.sets[j].bench,
                                    setNumber: j + 1
                                });
                            }
                        }
                        
                        // Separate players into: not benched today vs benched today
                        const notBenchedToday = players.filter(p => 
                            !benchedThisWeek.some(b => b.playerId === p.id)
                        );
                        
                        // Rank ALL non-benched players together by fairness (weighted points priority)
                        const rankedNotBenched = rankPlayersByFairness(notBenchedToday, set.number, currentWeek);
                        
                        // For benched players, keep them in chronological order (earliest benched first)
                        const rankedBenched = benchedThisWeek.map(b => 
                            players.find(p => p.id === b.playerId)
                        ).filter(p => p); // Remove nulls, keep chronological order

                        let displayRank = 1;
                        
                        // Display all non-benched players first (ranked by weighted points)
                        rankedNotBenched.forEach((player) => {
                            const isSelected = set.bench === player.id;
                            const rankClass = displayRank <= 5 ? `rank-${displayRank}` : '';
                            let rankLabel = '';
                            if (displayRank === 1) rankLabel = t('rank_1st');
                            else if (displayRank === 2) rankLabel = t('rank_2nd');
                            else if (displayRank === 3) rankLabel = t('rank_3rd');
                            else if (displayRank === 4) rankLabel = t('rank_4th');
                            else if (displayRank === 5) rankLabel = t('rank_5th');
                            
                            html += `<div class="bench-option ${rankClass} ${isSelected ? 'selected' : ''}" 
                                onclick="selectBench(${set.number}, ${player.id})">
                                ${player.name}
                                ${rankLabel ? `<span class="rank-badge">${rankLabel}</span>` : ''}
                            </div>`;
                            displayRank++;
                        });

                        // Display benched players last (ordered by when they were benched)
                        rankedBenched.forEach((player) => {
                            const isSelected = set.bench === player.id;
                            const rankClass = displayRank <= 5 ? `rank-${displayRank}` : '';
                            let rankLabel = '';
                            if (displayRank === 1) rankLabel = t('rank_1st');
                            else if (displayRank === 2) rankLabel = t('rank_2nd');
                            else if (displayRank === 3) rankLabel = t('rank_3rd');
                            else if (displayRank === 4) rankLabel = t('rank_4th');
                            else if (displayRank === 5) rankLabel = t('rank_5th');
                            
                            html += `<div class="bench-option ${rankClass} ${isSelected ? 'selected' : ''}" 
                                onclick="selectBench(${set.number}, ${player.id})">
                                ${player.name}
                                ${rankLabel ? `<span class="rank-badge">${rankLabel}</span>` : ''}
                            </div>`;
                            displayRank++;
                        });
                    }

                    html += `</div></div>`;

                    // Add "arrived late" checkbox for Set 1
                    if (i === 0 && set.bench !== null) {
                        const isLate = set.arrivedLate || false;
                        html += `<div style="margin-top: 15px; padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox"
                                    ${isLate ? 'checked' : ''}
                                    onchange="toggleArrivedLate(${set.number})"
                                    style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-weight: 500;">Player arrived late (no points awarded)</span>
                            </label>
                        </div>`;
                    }
                }

                // Court display
                if (set.bench !== null) {
                    // Check if both teams are complete (2 players each)
                    const teamsComplete = set.team1 && set.team1.length === 2 && set.team2 && set.team2.length === 2;
                    
                    // Team Builder - show until both teams are complete
                    if (!set.locked && !teamsComplete) {
                        html += `<div class="team-builder">
                            <h4>${t('build_teams')}</h4>
                            <div class="teams-grid">
                                <div class="team-box">
                                    <h5>${t('team_1')}</h5>
                                    <div class="player-dropzone ${set.team1 && set.team1.length === 2 ? 'has-players' : ''}" id="team1-set${set.number}">
                                        ${set.team1 && set.team1.length > 0 ? set.team1.map(id => {
                                            const p = players.find(pl => pl.id === id);
                                            return `<span class="player-draggable in-team" onclick="removeFromTeam(${set.number}, 1, ${id})">${p.name} ‚úï</span>`;
                                        }).join('') : `<span style="color: #999; font-style: italic;">${t('click_2_players')}</span>`}
                                    </div>
                                </div>
                                <div class="team-box">
                                    <h5>${t('team_2')}</h5>
                                    <div class="player-dropzone ${set.team2 && set.team2.length === 2 ? 'has-players' : ''}" id="team2-set${set.number}">
                                        ${set.team2 && set.team2.length > 0 ? set.team2.map(id => {
                                            const p = players.find(pl => pl.id === id);
                                            return `<span class="player-draggable in-team" onclick="removeFromTeam(${set.number}, 2, ${id})">${p.name} ‚úï</span>`;
                                        }).join('') : `<span style="color: #999; font-style: italic;">${t('click_2_players')}</span>`}
                                    </div>
                                </div>
                            </div>
                            <div class="available-players">
                                <h5>${t('available_players')}</h5>`;
                        
                        const onCourt = players.filter(p => p.id !== set.bench);
                        const assignedIds = [...(set.team1 || []), ...(set.team2 || [])];
                        const availablePlayers = onCourt.filter(p => !assignedIds.includes(p.id));
                        
                        availablePlayers.forEach(p => {
                            html += `<span class="player-draggable" onclick="addToTeam(${set.number}, ${p.id})">${p.name}</span>`;
                        });
                        
                        if (availablePlayers.length === 0) {
                            html += `<span style="color: #28a745; font-weight: 600;">${t('all_assigned')}</span>`;
                        }
                        
                        html += `</div></div>`;
                    }

                    // Display locked teams - only show when BOTH teams have 2 players
                    if (teamsComplete) {
                        const team1Players = set.team1.map(id => players.find(p => p.id === id).name);
                        const team2Players = set.team2.map(id => players.find(p => p.id === id).name);
                        
                        html += `<div class="court-display">
                            <h4>${t('teams_on_court')}</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                                <div style="padding: 10px; background: #f8f9fa; border-radius: 5px; border: 2px solid #6c757d;">
                                    <strong style="color: #667eea;">${t('team_1')}:</strong><br>
                                    ${team1Players.join(' & ')}
                                </div>
                                <div style="padding: 10px; background: #f8f9fa; border-radius: 5px; border: 2px solid #6c757d;">
                                    <strong style="color: #667eea;">${t('team_2')}:</strong><br>
                                    ${team2Players.join(' & ')}
                                </div>
                            </div>
                        </div>`;

                        // Winner selection
                        if (!set.locked) {
                            // For Set 3 and Set 4, add duration selector
                            if (set.number === 3) {
                                const currentDuration = set.set3Duration || 'full';
                                html += `<div class="bench-selection" style="margin-bottom: 20px;">
                                    <h4>${t('set3_duration')}</h4>
                                    <div class="bench-options">
                                        <div class="bench-option ${currentDuration === 'full' ? 'selected' : ''}"
                                            onclick="selectSet3Duration('full')">
                                            ${t('duration_full')}
                                        </div>
                                        <div class="bench-option ${currentDuration === 'two-thirds' ? 'selected' : ''}"
                                            onclick="selectSet3Duration('two-thirds')">
                                            ${t('duration_two_thirds')}
                                        </div>
                                        <div class="bench-option ${currentDuration === 'less-half' ? 'selected' : ''}"
                                            onclick="selectSet3Duration('less-half')">
                                            ${t('duration_less_half')}
                                        </div>
                                    </div>
                                </div>`;
                            } else if (set.number === 4) {
                                const currentDuration = set.set4Duration || 'full';
                                html += `<div class="bench-selection" style="margin-bottom: 20px;">
                                    <h4>Set 4 Duration:</h4>
                                    <div class="bench-options">
                                        <div class="bench-option ${currentDuration === 'full' ? 'selected' : ''}"
                                            onclick="selectSet4Duration('full')">
                                            ${t('duration_full')}
                                        </div>
                                        <div class="bench-option ${currentDuration === 'two-thirds' ? 'selected' : ''}"
                                            onclick="selectSet4Duration('two-thirds')">
                                            ${t('duration_two_thirds')}
                                        </div>
                                        <div class="bench-option ${currentDuration === 'less-half' ? 'selected' : ''}"
                                            onclick="selectSet4Duration('less-half')">
                                            ${t('duration_less_half')}
                                        </div>
                                    </div>
                                </div>`;
                            }

                            html += `<div class="winner-selection">
                                <h4>${(set.number === 3 || set.number === 4) ? t('select_winner_optional') : t('select_winner')}:</h4>
                                <div class="winner-options">
                                    <div class="winner-option ${set.winners && JSON.stringify(set.winners.sort()) === JSON.stringify([...set.team1].sort()) ? 'selected' : ''}"
                                        onclick="selectWinners(${set.number}, [${set.team1}])">
                                        ${t('team_1')}: ${team1Players.join(' & ')}
                                    </div>
                                    <div class="winner-option ${set.winners && JSON.stringify(set.winners.sort()) === JSON.stringify([...set.team2].sort()) ? 'selected' : ''}"
                                        onclick="selectWinners(${set.number}, [${set.team2}])">
                                        ${t('team_2')}: ${team2Players.join(' & ')}
                                    </div>
                                </div>
                            </div>`;

                            // For Set 3 and Set 4, allow locking without winner
                            if (set.number === 3 || set.number === 4) {
                                html += `<div style="display: flex; gap: 10px; margin-top: 10px;">`;
                                if (set.winners) {
                                    html += `<button class="btn btn-success" onclick="lockSet(${set.number})">${t('btn_lock_set_winner', set.number)}</button>`;
                                }
                                html += `<button class="btn btn-secondary" onclick="lockSet(${set.number}, true)">${t('btn_lock_set_no_winner', set.number)}</button>
                                </div>`;
                            }
                            // Sets 1 and 2 automatically lock when winner is selected - no button needed
                        }

                        if (set.locked) {
                            const winnerTeamNum = set.winners ? (JSON.stringify(set.winners.sort()) === JSON.stringify([...set.team1].sort()) ? 1 : 2) : null;
                            const winnerNames = winnerTeamNum ? (winnerTeamNum === 1 ? team1Players.join(' & ') : team2Players.join(' & ')) : null;
                            const benchedPlayerName = set.bench !== null ? players.find(p => p.id === set.bench).name : t('benched');
                            html += `<div style="background: #f8f9ff; color: #495057; border: 1px solid #c7d2fe; padding: 15px 20px; border-radius: 8px; margin: 0; font-size: 14px; font-weight: 500;">
                                ${t('msg_set_locked')}${winnerNames ? ` - <span style="color: #667eea; font-weight: 600;">${t('winners')}: ${t('team')} ${winnerTeamNum} (${winnerNames})</span>` : t('msg_no_winner_time')} | <span style="color: #6c757d;">${t('benched')}: ${benchedPlayerName}</span>
                            </div>`;
                        }
                    }
                } else {
                    html += `<button class="btn btn-primary" onclick="autoSelectBench(${set.number})">
                        ${t('btn_auto_select')}
                    </button>`;
                }

                // Add Clear Set button if any data has been entered for this set
                if (set.bench !== null || set.team1 !== null || set.team2 !== null || set.winners !== null || set.locked) {
                    html += `<button class="btn btn-danger" onclick="clearSet(${set.number})" style="margin-left: 10px; font-size: 13px;">
                        ${t('btn_clear_set', set.number)}
                    </button>`;
                }

                html += `</div>`;
            }

            html += '</div>';

            // Add complete week button - check only the sets that should be played
            const requiredSets = currentWeek.sets.slice(0, currentWeek.numberOfSets);
            const allRequiredSetsLocked = requiredSets.every(s => s.locked);

            if (allRequiredSetsLocked) {
                html += `<button class="btn btn-success" onclick="completeWeek()" style="margin-top: 20px;">
                    ${t('btn_complete_week')} ${currentWeek.weekNumber}
                </button>`;
            }

            document.getElementById('setsContainer').innerHTML = html;
        }

        async function setNumberOfSets(number) {
            try {
                const currentWeek = await getFromStore('currentWeek', 'current');
                if (!currentWeek) return;

                // Prevent changing if Set 3 or Set 4 is already locked
                if (currentWeek.sets[2] && currentWeek.sets[2].locked) {
                    alert('Cannot change number of sets after Set 3 is locked!');
                    return;
                }
                if (currentWeek.sets[3] && currentWeek.sets[3].locked) {
                    alert('Cannot change number of sets after Set 4 is locked!');
                    return;
                }

                currentWeek.numberOfSets = number;
                await saveToStore('currentWeek', currentWeek);
                await displayCurrentWeek();
            } catch (error) {
                console.error('Error setting number of sets:', error);
            }
        }

        async function selectBench(setNumber, playerId) {
            try {
                const currentWeek = await getFromStore('currentWeek', 'current');
                if (!currentWeek) return;
                currentWeek.sets[setNumber - 1].bench = playerId;
                // Reset teams when bench changes
                currentWeek.sets[setNumber - 1].team1 = null;
                currentWeek.sets[setNumber - 1].team2 = null;
                currentWeek.sets[setNumber - 1].winners = null;
                await saveToStore('currentWeek', currentWeek);
                await displayCurrentWeek();
            } catch (error) {
                console.error('Error selecting bench:', error);
            }
        }

        async function toggleArrivedLate(setNumber) {
            try {
                const currentWeek = await getFromStore('currentWeek', 'current');
                if (!currentWeek) return;
                const set = currentWeek.sets[setNumber - 1];
                set.arrivedLate = !set.arrivedLate;
                await saveToStore('currentWeek', currentWeek);
                await displayCurrentWeek();
            } catch (error) {
                console.error('Error toggling arrived late:', error);
            }
        }

        async function addToTeam(setNumber, playerId) {
            try {
                const currentWeek = await getFromStore('currentWeek', 'current');
                if (!currentWeek) return;
                const set = currentWeek.sets[setNumber - 1];

                // Initialize arrays if they don't exist
                if (!set.team1) set.team1 = [];
                if (!set.team2) set.team2 = [];

                // Add to Team 1 if it has space
                if (set.team1.length < 2) {
                    set.team1.push(playerId);
                } 
                // Otherwise add to Team 2 if it has space
                else if (set.team2.length < 2) {
                    set.team2.push(playerId);
                }

                await saveToStore('currentWeek', currentWeek);
                await displayCurrentWeek();
            } catch (error) {
                console.error('Error adding to team:', error);
            }
        }

        async function removeFromTeam(setNumber, teamNumber, playerId) {
            try {
                const currentWeek = await getFromStore('currentWeek', 'current');
                if (!currentWeek) return;
                const set = currentWeek.sets[setNumber - 1];

                if (teamNumber === 1 && set.team1) {
                    set.team1 = set.team1.filter(id => id !== playerId);
                    if (set.team1.length === 0) set.team1 = null;
                } else if (teamNumber === 2 && set.team2) {
                    set.team2 = set.team2.filter(id => id !== playerId);
                    if (set.team2.length === 0) set.team2 = null;
                }

                // Reset winners when teams change
                set.winners = null;

                await saveToStore('currentWeek', currentWeek);
                await displayCurrentWeek();
            } catch (error) {
                console.error('Error removing from team:', error);
            }
        }

        async function autoSelectBench(setNumber) {
            try {
                const players = await loadPlayers();
                const currentWeek = await getFromStore('currentWeek', 'current');
                if (!players || !currentWeek) return;

                // Get winners from previous set and previous bencher
                const winnersLastSet = setNumber > 1 && currentWeek.sets[setNumber - 2].winners ? 
                    currentWeek.sets[setNumber - 2].winners : [];
                const previousBencher = setNumber > 1 ? currentWeek.sets[setNumber - 2].bench : null;

                // Prioritize losers (not winners, not previous bencher)
                const losersPlayers = players.filter(p => 
                    !winnersLastSet.includes(p.id) && p.id !== previousBencher
                );

                // If we have losers available, select the best loser
                if (losersPlayers.length > 0) {
                    const rankedLosers = rankPlayersByFairness(losersPlayers, setNumber, currentWeek);
                    currentWeek.sets[setNumber - 1].bench = rankedLosers[0].id;
                } else {
                    // Fallback: if no losers available, select from winners (should rarely happen)
                    const winnersPlayers = players.filter(p => winnersLastSet.includes(p.id));
                    if (winnersPlayers.length > 0) {
                        const rankedWinners = rankPlayersByFairness(winnersPlayers, setNumber, currentWeek);
                        currentWeek.sets[setNumber - 1].bench = rankedWinners[0].id;
                    }
                }

                await saveToStore('currentWeek', currentWeek);
                await displayCurrentWeek();
            } catch (error) {
                console.error('Error auto-selecting bench:', error);
            }
        }

        async function selectSet3Duration(duration) {
            try {
                const currentWeek = await getFromStore('currentWeek', 'current');
                if (!currentWeek) return;

                // Update Set 3 duration
                currentWeek.sets[2].set3Duration = duration;

                await saveToStore('currentWeek', currentWeek);
                await displayCurrentWeek();
            } catch (error) {
                console.error('Error selecting Set 3 duration:', error);
            }
        }

        async function selectSet4Duration(duration) {
            try {
                const currentWeek = await getFromStore('currentWeek', 'current');
                if (!currentWeek) return;

                // Update Set 4 duration
                currentWeek.sets[3].set4Duration = duration;

                await saveToStore('currentWeek', currentWeek);
                await displayCurrentWeek();
            } catch (error) {
                console.error('Error selecting Set 4 duration:', error);
            }
        }

        async function selectWinners(setNumber, winners) {
            try {
                const currentWeek = await getFromStore('currentWeek', 'current');
                if (!currentWeek) return;
                currentWeek.sets[setNumber - 1].winners = winners;
                
                // Automatically lock Sets 1 and 2 when winner is selected
                if (setNumber === 1 || setNumber === 2) {
                    currentWeek.sets[setNumber - 1].locked = true;
                }
                
                await saveToStore('currentWeek', currentWeek);
                await displayCurrentWeek();
            } catch (error) {
                console.error('Error selecting winners:', error);
            }
        }

        async function lockSet(setNumber, noWinner = false) {
            try {
                const currentWeek = await getFromStore('currentWeek', 'current');
                if (!currentWeek) return;
                const set = currentWeek.sets[setNumber - 1];
                
                // For Sets 1 and 2, require a winner
                if (setNumber !== 3 && !set.winners) {
                    alert('Please select a winning team before locking this set.');
                    return;
                }
                
                // For Set 3, allow locking without winner if noWinner flag is true
                if (setNumber === 3 && noWinner) {
                    set.winners = null; // Explicitly set to null for no winner
                }
                
                set.locked = true;
                await saveToStore('currentWeek', currentWeek);
                await displayCurrentWeek();
            } catch (error) {
                console.error('Error locking set:', error);
            }
        }

        // Custom confirmation dialog to bypass sandbox restrictions
        async function showCustomConfirm(title, message, confirmText = 'Yes, Continue', cancelText = 'Cancel', isDanger = false) {
            const confirmDialog = document.createElement('div');
            confirmDialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const dangerColor = isDanger ? '#dc3545' : '#667eea';
            
            confirmDialog.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <h3 style="color: ${dangerColor}; margin-top: 0;">${title}</h3>
                    <div style="margin: 15px 0; line-height: 1.6; white-space: pre-line;">
                        ${message}
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button id="customConfirmYes" style="flex: 1; padding: 12px; background: ${dangerColor}; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600;">
                            ${confirmText}
                        </button>
                        <button id="customConfirmNo" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600;">
                            ${cancelText}
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDialog);
            
            return new Promise((resolve) => {
                document.getElementById('customConfirmYes').onclick = () => {
                    document.body.removeChild(confirmDialog);
                    resolve(true);
                };
                document.getElementById('customConfirmNo').onclick = () => {
                    document.body.removeChild(confirmDialog);
                    resolve(false);
                };
            });
        }

        async function clearSet(setNumber) {
            const message = `This will delete all data for Set ${setNumber}:

‚Ä¢ Benched player
‚Ä¢ Team assignments
‚Ä¢ Winner selection
‚Ä¢ Locked status

You will need to re-enter all information for this set.

Are you sure you want to continue?`;

            const userResponse = await showCustomConfirm(
                `‚ö†Ô∏è WARNING: Clear Set ${setNumber}?`,
                message,
                'Yes, Clear Set',
                'Cancel',
                true
            );

            if (!userResponse) {
                return;
            }

            try {
                const currentWeek = await getFromStore('currentWeek', 'current');
                if (!currentWeek) {
                    alert('No active week found.');
                    return;
                }

                // Reset the set to default state
                const resetSet = {
                    number: setNumber,
                    bench: null,
                    team1: null,
                    team2: null,
                    winners: null,
                    locked: false
                };
                
                // Add set3Duration for Set 3
                if (setNumber === 3) {
                    resetSet.set3Duration = 'full';
                }
                
                currentWeek.sets[setNumber - 1] = resetSet;

                await saveToStore('currentWeek', currentWeek);
                await displayCurrentWeek();
                
                console.log(`Set ${setNumber} cleared successfully`);
            } catch (error) {
                console.error('Error clearing set:', error);
                alert('Error clearing set: ' + error.message);
            }
        }

        async function resetCurrentWeekNoConfirm() {
            console.log('resetCurrentWeek called with confirmation');
            try {
                const currentWeek = await getFromStore('currentWeek', 'current');
                console.log('Current week data:', currentWeek);
                
                if (!currentWeek) {
                    alert('No active week to reset.');
                    return;
                }

                const message = `This will DELETE all current data for Week ${currentWeek.weekNumber}:

‚Ä¢ All bench selections
‚Ä¢ All team assignments  
‚Ä¢ All winner selections
‚Ä¢ All set progress

The week will be completely reset and you'll need to start over.

Are you sure you want to continue?`;

                const confirmed = await showCustomConfirm(
                    `‚ö†Ô∏è RESET WEEK ${currentWeek.weekNumber}?`,
                    message,
                    'Yes, Clear & Restart',
                    'Cancel',
                    true
                );

                if (!confirmed) {
                    console.log('Week reset cancelled by user');
                    return;
                }

                // Clear the current week data
                console.log('Clearing current week...');
                await clearStore('currentWeek');
                console.log('Current week cleared successfully');

                // Refresh the display
                console.log('Refreshing display...');
                await displayCurrentWeek();
                console.log('Display refreshed');
                console.log('Week reset completed successfully');

            } catch (error) {
                console.error('Error resetting current week:', error);
                alert('‚ùå Error resetting week:\n\n' + error.message + '\n\nPlease try again or refresh the page.');
            }
        }

        async function resetCurrentWeek() {
            console.log('resetCurrentWeek called');
            try {
                const currentWeek = await getFromStore('currentWeek', 'current');
                console.log('Current week data:', currentWeek);
                
                if (!currentWeek) {
                    alert('No active week to reset.');
                    return;
                }

                // More prominent confirmation dialog
                const confirmMessage = 
                    `‚ö†Ô∏è RESET WEEK ${currentWeek.weekNumber}? ‚ö†Ô∏è\n\n` +
                    `This will DELETE all current data:\n` +
                    `‚Ä¢ All bench selections\n` +
                    `‚Ä¢ All team assignments\n` +
                    `‚Ä¢ All winner selections\n\n` +
                    `Historical data will NOT be affected.\n\n` +
                    `Click OK to RESET, or Cancel to keep current week.`;

                const confirmReset = confirm(confirmMessage);

                console.log('User confirmed reset:', confirmReset);

                if (!confirmReset) {
                    console.log('User cancelled reset');
                    return;
                }

                // Clear the current week data
                console.log('Clearing current week...');
                await clearStore('currentWeek');
                console.log('Current week cleared successfully');

                // Refresh the display
                console.log('Refreshing display...');
                await displayCurrentWeek();
                console.log('Display refreshed');
                
                // Show success message AFTER the display has been updated
                setTimeout(() => {
                    alert('‚úÖ Week reset successfully!\n\nYou can now start a new week.');
                }, 100);

            } catch (error) {
                console.error('Error resetting current week:', error);
                alert('‚ùå Error resetting week:\n\n' + error.message + '\n\nPlease try again or refresh the page.');
            }
        }

        async function completeWeek() {
            try {
                const currentWeek = await getFromStore('currentWeek', 'current');
                const players = await loadPlayers();
                if (!currentWeek || !players) return;

                // Get Set 3 and Set 4 duration point values
                const set3Duration = currentWeek.sets[2].set3Duration || 'full';
                const set3PointValue = set3Duration === 'full' ? 1.0 :
                                       set3Duration === 'two-thirds' ? 0.8 : 0.6;

                const set4Duration = currentWeek.sets[3] ? (currentWeek.sets[3].set4Duration || 'full') : 'full';
                const set4PointValue = set4Duration === 'full' ? 1.0 :
                                       set4Duration === 'two-thirds' ? 0.8 : 0.6;

                // Update player statistics - only process sets that were actually played
                const numberOfSets = currentWeek.numberOfSets || 3;
                currentWeek.sets.slice(0, numberOfSets).forEach((set, index) => {
                    const player = players.find(p => p.id === set.bench);
                    if (player) {
                        if (index === 0) {
                            // Only increment Set 1 benches if player didn't arrive late
                            if (!set.arrivedLate) {
                                player.set1Benches++;
                            }
                        }
                        if (index === 1) {
                            player.set2Benches++;
                        }
                        if (index === 2) {
                            player.set3Benches++;
                            // Initialize set3Points if it doesn't exist
                            if (!player.set3Points) player.set3Points = 0;
                            player.set3Points += set3PointValue;
                        }
                        if (index === 3) {
                            // Initialize set4Benches if it doesn't exist (for existing players)
                            if (!player.set4Benches) player.set4Benches = 0;
                            player.set4Benches++;
                            // Initialize set4Points if it doesn't exist
                            if (!player.set4Points) player.set4Points = 0;
                            player.set4Points += set4PointValue;
                        }
                        // Only count towards total if not a late arrival in Set 1
                        if (index !== 0 || !set.arrivedLate) {
                            player.totalBenches++;
                        }
                    }
                });

                // Save updated players
                await saveToStore('players', { id: 'playerList', players: players });

                // Save completed week
                currentWeek.completed = true;
                await saveToStore('weeks', currentWeek);

                // Clear current week
                await clearStore('currentWeek');

                alert(`Week ${currentWeek.weekNumber} completed!`);
                await displayCurrentWeek();
            } catch (error) {
                console.error('Error completing week:', error);
                alert('Error completing week. Please try again.');
            }
        }

        // Statistics display
        async function displayStats() {
            try {
                const players = await loadPlayers();
                if (!players) {
                    document.getElementById('statsContainer').innerHTML = 
                        `<div class="no-data"><div class="no-data-icon">üìä</div><p>${t('msg_no_players')}</p></div>`;
                    return;
                }

                // Calculate weighted bench scores for each player
                // Weights: Set 1 = 1.0, Set 2 = 1.0, Set 3 = variable, Set 4 = variable
                const playersWithScores = players.map(player => ({
                    ...player,
                    weightedScore: (player.set1Benches * 1.0) + (player.set2Benches * 1.0) + (player.set3Points || 0) + (player.set4Points || 0)
                }));

                // Sort players by weighted score (descending - highest score first shows most benched)
                const sortedPlayers = [...playersWithScores].sort((a, b) => {
                    // Priority 1: Weighted score (descending - highest score first)
                    if (a.weightedScore !== b.weightedScore) {
                        return b.weightedScore - a.weightedScore;
                    }
                    // Priority 2: Total benches
                    if (a.totalBenches !== b.totalBenches) {
                        return b.totalBenches - a.totalBenches;
                    }
                    // Priority 3: Name (alphabetical)
                    return a.name.localeCompare(b.name);
                });

                // Calculate max weighted score for proportional display (now first element)
                const maxWeightedScore = sortedPlayers.length > 0 ? sortedPlayers[0].weightedScore : 0;

                let html = `<div class="stats-table-wrapper"><table class="stats-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>${t('player')}</th>
                            <th>${t('set1_benches')}</th>
                            <th>${t('set2_benches')}</th>
                            <th>${t('set3_benches')}</th>
                            <th>${t('set4_benches')}</th>
                            <th>${t('total_benches')}</th>
                            <th>${t('points')}</th>
                        </tr>
                    </thead>
                    <tbody>`;

                sortedPlayers.forEach((player, index) => {
                    const rank = index + 1;
                    
                    // Calculate proportion of weighted score (0 to 1)
                    const proportion = maxWeightedScore > 0 ? player.weightedScore / maxWeightedScore : 0;
                    
                    // Create points display (just the weighted score)
                    let pointsDisplay = '';
                    
                    if (player.weightedScore === 0) {
                        pointsDisplay = `<span style="color: #999;">0</span>`;
                    } else {
                        const weightedScoreDisplay = player.weightedScore.toFixed(1);
                        pointsDisplay = `<span style="color: #000; font-weight: 600;">${weightedScoreDisplay}</span>`;
                    }

                    html += `<tr>
                        <td><span class="rank-number">${rank}</span></td>
                        <td>${player.name}</td>
                        <td>${player.set1Benches}</td>
                        <td>${player.set2Benches}</td>
                        <td>${player.set3Benches}</td>
                        <td>${player.set4Benches || 0}</td>
                        <td>${player.totalBenches}</td>
                        <td>${pointsDisplay}</td>
                    </tr>`;
                });

                html += `</tbody></table></div>`;
                html += `<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; font-size: 0.95em; color: #666;">
                    <strong>${t('scoring_system')}</strong><br>
                    ${t('set1_points_info')}<br>
                    ${t('set2_points_info')}<br>
                    ${t('set3_points_info')}<br>
                    &nbsp;&nbsp;&nbsp;${t('set3_full')}<br>
                    &nbsp;&nbsp;&nbsp;${t('set3_two_thirds')}<br>
                    &nbsp;&nbsp;&nbsp;${t('set3_less_half')}<br>
                    ${t('set4_points_info')}<br>
                    &nbsp;&nbsp;&nbsp;${t('set4_full')}<br>
                    &nbsp;&nbsp;&nbsp;${t('set4_two_thirds')}<br>
                    &nbsp;&nbsp;&nbsp;${t('set4_less_half')}<br>
                    <br>
                    ${t('late_arrival_info')}<br>
                    <br>
                    ${t('points_column_info')}<br>
                    <br>
                    ${t('scoring_example')}<br>
                    <br>
                    ${t('ranking_info')}
                </div>`;
                
                document.getElementById('statsContainer').innerHTML = html;
            } catch (error) {
                console.error('Error displaying stats:', error);
                document.getElementById('statsContainer').innerHTML = 
                    `<div class="status-warning">${currentLang === 'en' ? 'Error loading statistics.' : 'Eroare la √ÆncƒÉrcarea statisticilor.'}</div>`;
            }
        }

        // History display
        async function displayHistory() {
            const weeks = await getAllFromStore('weeks');
            const players = await loadPlayers();

            if (!weeks || weeks.length === 0) {
                document.getElementById('historyContainer').innerHTML = 
                    `<div class="no-data"><div class="no-data-icon">üìú</div><p>${t('no_history')}</p></div>`;
                return;
            }

            let html = '';
            weeks.sort((a, b) => b.weekNumber - a.weekNumber).forEach(week => {
                html += `<div class="week-card">
                    <div class="week-card-header">
                        <h3>${t('week')} ${week.weekNumber}</h3>
                        <button class="delete-week-btn" onclick="deleteWeek(${week.weekNumber})">
                            üóëÔ∏è Delete Week
                        </button>
                    </div>
                    <div class="week-sets">`;

                week.sets.forEach(set => {
                    const benchPlayer = players.find(p => p.id === set.bench);
                    
                    let winnerDisplay = '';
                    if (!set.winners) {
                        winnerDisplay = t('no_winner_time_limit');
                    } else if (set.team1 && set.team2) {
                        const team1Players = set.team1.map(id => players.find(p => p.id === id).name);
                        const team2Players = set.team2.map(id => players.find(p => p.id === id).name);
                        const isTeam1Winner = JSON.stringify([...set.winners].sort()) === JSON.stringify([...set.team1].sort());
                        winnerDisplay = isTeam1Winner ? 
                            `${t('team_1')}: ${team1Players.join(' & ')}` : 
                            `${t('team_2')}: ${team2Players.join(' & ')}`;
                    } else {
                        const winnerNames = players.filter(p => set.winners && set.winners.includes(p.id))
                            .map(p => p.name).join(' & ');
                        winnerDisplay = winnerNames;
                    }

                    html += `<div class="week-set">
                        <div class="week-set-header">
                            <span>${t('set')} ${set.number}</span>
                            <span class="winner-badge${!set.winners ? '' : ''}">${set.winners ? t('winners') : t('result')}: ${winnerDisplay}</span>
                        </div>`;
                    
                    if (set.team1 && set.team2) {
                        const team1Players = set.team1.map(id => players.find(p => p.id === id).name);
                        const team2Players = set.team2.map(id => players.find(p => p.id === id).name);
                        html += `
                            <div style="margin-top: 8px; font-size: 0.9em;">
                                <div>${t('team_1')}: ${team1Players.join(' & ')}</div>
                                <div>${t('team_2')}: ${team2Players.join(' & ')}</div>
                            </div>`;
                    }
                    
                    html += `<div style="margin-top: 5px;">${t('bench')}: <strong>${benchPlayer.name}</strong>`;

                    // Show late arrival indicator for Set 1
                    if (set.number === 1 && set.arrivedLate) {
                        html += ` <span style="color: #ff6b6b; font-size: 0.85em;">(arrived late - no points)</span>`;
                    }

                    html += `</div>
                    </div>`;
                });

                html += `</div></div>`;
            });

            document.getElementById('historyContainer').innerHTML = html;
        }

        // Delete a specific week from history
        async function deleteWeek(weekNumber) {
            const confirmed = confirm(`Are you sure you want to delete Week ${weekNumber}?\n\nThis will permanently remove all data for this week, including:\n- Bench assignments\n- Team compositions\n- Match results\n\nThis action cannot be undone.`);
            
            if (!confirmed) {
                return;
            }

            try {
                // Get all weeks
                const weeks = await getAllFromStore('weeks');
                
                // Find and remove the specified week
                const weekToDelete = weeks.find(w => w.weekNumber === weekNumber);
                if (!weekToDelete) {
                    alert('Week not found!');
                    return;
                }

                // Remove the week from IndexedDB (using weekNumber as key)
                await deleteFromStore('weeks', weekNumber);

                // Update player statistics (subtract the deleted week's data)
                const players = await loadPlayers();
                
                // Get set duration point values from the deleted week
                const set3Duration = weekToDelete.sets[2] ? (weekToDelete.sets[2].set3Duration || 'full') : 'full';
                const set3PointValue = set3Duration === 'full' ? 1.0 :
                                       set3Duration === 'two-thirds' ? 0.8 : 0.6;

                const set4Duration = weekToDelete.sets[3] ? (weekToDelete.sets[3].set4Duration || 'full') : 'full';
                const set4PointValue = set4Duration === 'full' ? 1.0 :
                                       set4Duration === 'two-thirds' ? 0.8 : 0.6;
                
                weekToDelete.sets.forEach(set => {
                    if (set.bench) {
                        const player = players.find(p => p.id === set.bench);
                        if (player) {
                            // Only decrease total benches if not a late arrival in Set 1
                            if (set.number !== 1 || !set.arrivedLate) {
                                player.totalBenches = Math.max(0, player.totalBenches - 1);
                            }
                            
                            // Decrease set-specific benches and points
                            if (set.number === 1) {
                                // Only decrease if player didn't arrive late
                                if (!set.arrivedLate) {
                                    player.set1Benches = Math.max(0, player.set1Benches - 1);
                                }
                            } else if (set.number === 2) {
                                player.set2Benches = Math.max(0, player.set2Benches - 1);
                            } else if (set.number === 3) {
                                if (player.set3Benches !== undefined) {
                                    player.set3Benches = Math.max(0, player.set3Benches - 1);
                                }
                                // Decrease set3Points
                                if (player.set3Points !== undefined) {
                                    player.set3Points = Math.max(0, player.set3Points - set3PointValue);
                                }
                            } else if (set.number === 4) {
                                if (player.set4Benches !== undefined) {
                                    player.set4Benches = Math.max(0, player.set4Benches - 1);
                                }
                                // Decrease set4Points
                                if (player.set4Points !== undefined) {
                                    player.set4Points = Math.max(0, player.set4Points - set4PointValue);
                                }
                            }
                        }
                    }
                });

                // Save updated player data with correct structure
                await saveToStore('players', { id: 'playerList', players: players });

                // Refresh displays
                await displayHistory();
                await displayStats();

                alert(`Week ${weekNumber} has been successfully deleted.`);
            } catch (error) {
                console.error('Error deleting week:', error);
                alert('Error deleting week. Please try again.');
            }
        }

        // Manual historical data entry
        let manualWeekData = {
            numberOfSets: 3,
            set1: { bench: null, team1: null, team2: null, winners: null, arrivedLate: false },
            set2: { bench: null, team1: null, team2: null, winners: null },
            set3: { bench: null, team1: null, team2: null, winners: null },
            set4: { bench: null, team1: null, team2: null, winners: null }
        };

        function setManualNumberOfSets(number) {
            manualWeekData.numberOfSets = number;
            const set4Card = document.getElementById('manualSetCard4');
            const btn3 = document.getElementById('manualSets3Btn');
            const btn4 = document.getElementById('manualSets4Btn');

            if (number === 4) {
                if (set4Card) set4Card.style.display = '';
                if (btn4) {
                    btn4.classList.remove('btn-secondary');
                    btn4.classList.add('btn-primary');
                    btn4.style.opacity = '1';
                }
                if (btn3) {
                    btn3.classList.remove('btn-primary');
                    btn3.classList.add('btn-secondary');
                    btn3.style.opacity = '0.6';
                }
            } else {
                if (set4Card) set4Card.style.display = 'none';
                if (btn3) {
                    btn3.classList.remove('btn-secondary');
                    btn3.classList.add('btn-primary');
                    btn3.style.opacity = '1';
                }
                if (btn4) {
                    btn4.classList.remove('btn-primary');
                    btn4.classList.add('btn-secondary');
                    btn4.style.opacity = '0.6';
                }
                // Clear Set 4 data when switching to 3 sets
                manualWeekData.set4 = { bench: null, team1: null, team2: null, winners: null };
            }
        }

        async function initManualEntry() {
            const players = await loadPlayers();
            if (!players) {
                document.getElementById('manualStatus').innerHTML = 
                    '<div class="status-warning">Please set up players first in the Setup tab!</div>';
                return;
            }

            // Reset manual data
            manualWeekData = {
                numberOfSets: 3,
                set1: { bench: null, team1: null, team2: null, winners: null, arrivedLate: false },
                set2: { bench: null, team1: null, team2: null, winners: null },
                set3: { bench: null, team1: null, team2: null, winners: null },
                set4: { bench: null, team1: null, team2: null, winners: null }
            };

            // Populate bench dropdowns for all 4 sets
            for (let setNum = 1; setNum <= 4; setNum++) {
                const select = document.getElementById(`manualSet${setNum}Bench`);
                select.innerHTML = '<option value="">Select player...</option>';
                players.forEach(player => {
                    select.innerHTML += `<option value="${player.id}">${player.name}</option>`;
                });

                // Add change listener
                select.addEventListener('change', (e) => {
                    manualWeekData[`set${setNum}`].bench = e.target.value ? parseInt(e.target.value) : null;
                    manualWeekData[`set${setNum}`].team1 = null;
                    manualWeekData[`set${setNum}`].team2 = null;
                    manualWeekData[`set${setNum}`].winners = null;
                    updateManualWinnerOptions(setNum);
                });
            }

            // Add event listener for Set 1 arrived late checkbox
            const arrivedLateCheckbox = document.getElementById('manualSet1ArrivedLate');
            if (arrivedLateCheckbox) {
                arrivedLateCheckbox.addEventListener('change', (e) => {
                    manualWeekData.set1.arrivedLate = e.target.checked;
                });
            }

            // Initialize winner sections for all 4 sets
            for (let setNum = 1; setNum <= 4; setNum++) {
                updateManualWinnerOptions(setNum);
            }

            document.getElementById('manualStatus').innerHTML = '';
        }

        async function updateManualWinnerOptions(setNum) {
            const players = await loadPlayers();
            const benchId = manualWeekData[`set${setNum}`].bench;
            const container = document.getElementById(`manualSet${setNum}Winners`);

            if (!benchId) {
                container.innerHTML = '<p style="color: #999; font-style: italic;">Select a bench player first</p>';
                return;
            }

            const onCourt = players.filter(p => p.id !== parseInt(benchId));
            
            if (onCourt.length !== 4) {
                container.innerHTML = '<p style="color: #999;">Invalid configuration</p>';
                return;
            }

            // Show team builder
            const set = manualWeekData[`set${setNum}`];
            const assignedIds = [...(set.team1 || []), ...(set.team2 || [])];
            const availablePlayers = onCourt.filter(p => !assignedIds.includes(p.id));

            let html = `
                <div class="team-builder" style="margin-top: 10px;">
                    <h5 style="margin-bottom: 10px;">Build Teams:</h5>
                    <div class="teams-grid">
                        <div class="team-box">
                            <h5>Team 1</h5>
                            <div class="player-dropzone ${set.team1 && set.team1.length === 2 ? 'has-players' : ''}">
                                ${set.team1 ? set.team1.map(id => {
                                    const p = players.find(pl => pl.id === id);
                                    return `<span class="player-draggable in-team" onclick="removeFromManualTeam(${setNum}, 1, ${id})">${p.name} ‚úï</span>`;
                                }).join('') : '<span style="color: #999; font-style: italic; font-size: 0.9em;">Click 2 players below</span>'}
                            </div>
                        </div>
                        <div class="team-box">
                            <h5>Team 2</h5>
                            <div class="player-dropzone ${set.team2 && set.team2.length === 2 ? 'has-players' : ''}">
                                ${set.team2 ? set.team2.map(id => {
                                    const p = players.find(pl => pl.id === id);
                                    return `<span class="player-draggable in-team" onclick="removeFromManualTeam(${setNum}, 2, ${id})">${p.name} ‚úï</span>`;
                                }).join('') : '<span style="color: #999; font-style: italic; font-size: 0.9em;">Click 2 players below</span>'}
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <h5 style="margin-bottom: 10px;">Available Players:</h5>`;
            
            availablePlayers.forEach(p => {
                html += `<span class="player-draggable" onclick="addToManualTeam(${setNum}, ${p.id})">${p.name}</span>`;
            });

            if (availablePlayers.length === 0 && set.team1 && set.team2 && set.team1.length === 2 && set.team2.length === 2) {
                html += '<span style="color: #28a745; font-weight: 600;">‚úì All players assigned!</span>';
            }

            html += `</div></div>`;

            // Show winner selection if teams are complete
            if (set.team1 && set.team1.length === 2 && set.team2 && set.team2.length === 2) {
                const team1Players = set.team1.map(id => players.find(p => p.id === id).name);
                const team2Players = set.team2.map(id => players.find(p => p.id === id).name);

                const currentWinners = set.winners;
                const team1Selected = currentWinners && 
                    JSON.stringify([...currentWinners].sort()) === JSON.stringify([...set.team1].sort());
                const team2Selected = currentWinners && 
                    JSON.stringify([...currentWinners].sort()) === JSON.stringify([...set.team2].sort());

                html += `
                    <div style="margin-top: 15px;">
                        <h5>Select Winning Team ${setNum === 3 ? '(Optional for Set 3)' : ''}:</h5>
                        <div class="manual-winner-grid">
                            <div class="manual-winner-option ${team1Selected ? 'selected' : ''}" 
                                onclick="selectManualWinner(${setNum}, [${set.team1}])">
                                Team 1: ${team1Players.join(' & ')}
                            </div>
                            <div class="manual-winner-option ${team2Selected ? 'selected' : ''}" 
                                onclick="selectManualWinner(${setNum}, [${set.team2}])">
                                Team 2: ${team2Players.join(' & ')}
                            </div>
                        </div>`;
                
                // For Set 3, add option to skip winner selection
                if (setNum === 3) {
                    html += `
                        <div style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="selectManualWinner(${setNum}, null)" 
                                style="font-size: 0.9em; padding: 8px 16px;">
                                No Winner (Time Limit)
                            </button>
                        </div>`;
                }
                
                html += `</div>`;
            }

            container.innerHTML = html;
        }

        function addToManualTeam(setNum, playerId) {
            const set = manualWeekData[`set${setNum}`];

            // Initialize arrays if they don't exist
            if (!set.team1) set.team1 = [];
            if (!set.team2) set.team2 = [];

            // Add to Team 1 if it has space
            if (set.team1.length < 2) {
                set.team1.push(playerId);
            } 
            // Otherwise add to Team 2 if it has space
            else if (set.team2.length < 2) {
                set.team2.push(playerId);
            }

            updateManualWinnerOptions(setNum);
        }

        function removeFromManualTeam(setNum, teamNumber, playerId) {
            const set = manualWeekData[`set${setNum}`];

            if (teamNumber === 1 && set.team1) {
                set.team1 = set.team1.filter(id => id !== playerId);
                if (set.team1.length === 0) set.team1 = null;
            } else if (teamNumber === 2 && set.team2) {
                set.team2 = set.team2.filter(id => id !== playerId);
                if (set.team2.length === 0) set.team2 = null;
            }

            set.winners = null;
            updateManualWinnerOptions(setNum);
        }

        function selectManualWinner(setNum, winners) {
            manualWeekData[`set${setNum}`].winners = winners;
            updateManualWinnerOptions(setNum);
        }

        async function saveManualWeek() {
            const players = await loadPlayers();
            const weekNumberInput = document.getElementById('manualWeekNumber').value;

            // Validation
            if (!weekNumberInput || weekNumberInput < 1) {
                document.getElementById('manualStatus').innerHTML = 
                    '<div class="status-warning">Please enter a valid week number!</div>';
                return;
            }

            const weekNumber = parseInt(weekNumberInput);

            // Check if all sets have bench and teams (based on numberOfSets)
            const numberOfSets = manualWeekData.numberOfSets || 3;
            for (let setNum = 1; setNum <= numberOfSets; setNum++) {
                const set = manualWeekData[`set${setNum}`];
                if (!set.bench) {
                    document.getElementById('manualStatus').innerHTML =
                        `<div class="status-warning">Please select a bench player for Set ${setNum}!</div>`;
                    return;
                }
                if (!set.team1 || set.team1.length !== 2 || !set.team2 || set.team2.length !== 2) {
                    document.getElementById('manualStatus').innerHTML =
                        `<div class="status-warning">Please assign all players to teams for Set ${setNum}!</div>`;
                    return;
                }
                // Sets 1 and 2 require winners, Set 3 and 4 are optional
                if (setNum !== 3 && setNum !== 4 && !set.winners) {
                    document.getElementById('manualStatus').innerHTML =
                        `<div class="status-warning">Please select the winning team for Set ${setNum}!</div>`;
                    return;
                }
            }

            // Check if week already exists
            const weeks = await getAllFromStore('weeks');
            // Ensure weeks is always an array
            const weeksArray = Array.isArray(weeks) ? weeks : [];
            const existingWeek = weeksArray.find(w => w.weekNumber === weekNumber);
            
            if (existingWeek) {
                if (!confirm(`Week ${weekNumber} already exists. Do you want to overwrite it?`)) {
                    return;
                }
            }

            // Create week object - only include sets that were actually played
            const sets = [];
            for (let i = 1; i <= numberOfSets; i++) {
                const setData = manualWeekData[`set${i}`];
                const setObj = {
                    number: i,
                    bench: setData.bench,
                    team1: setData.team1,
                    team2: setData.team2,
                    winners: setData.winners || null,
                    locked: true
                };
                if (i === 1) setObj.arrivedLate = setData.arrivedLate || false;
                sets.push(setObj);
            }

            const weekData = {
                weekNumber: weekNumber,
                numberOfSets: numberOfSets,
                sets: sets,
                completed: true,
                manualEntry: true
            };

            // If overwriting, remove old statistics first
            if (existingWeek) {
                existingWeek.sets.forEach((set, index) => {
                    const player = players.find(p => p.id === set.bench);
                    if (player) {
                        if (index === 0 && !set.arrivedLate) player.set1Benches--;
                        if (index === 1) player.set2Benches--;
                        if (index === 2) {
                            player.set3Benches--;
                            // Subtract Set 3 points (default to 1.0 if not recorded)
                            if (!player.set3Points) player.set3Points = 0;
                            const oldSet3PointValue = set.set3PointValue || 1.0;
                            player.set3Points -= oldSet3PointValue;
                        }
                        if (index === 3) {
                            player.set4Benches--;
                            // Subtract Set 4 points (default to 1.0 if not recorded)
                            if (!player.set4Points) player.set4Points = 0;
                            const oldSet4PointValue = set.set4PointValue || 1.0;
                            player.set4Points -= oldSet4PointValue;
                        }
                        // Only decrement total if not a late arrival in Set 1
                        if (index !== 0 || !set.arrivedLate) {
                            player.totalBenches--;
                        }
                    }
                });
            }

            // Update player statistics
            weekData.sets.forEach((set, index) => {
                const player = players.find(p => p.id === set.bench);
                if (player) {
                    if (index === 0) {
                        // Only increment Set 1 benches if player didn't arrive late
                        if (!set.arrivedLate) {
                            player.set1Benches++;
                        }
                    }
                    if (index === 1) player.set2Benches++;
                    if (index === 2) {
                        player.set3Benches++;
                        // Initialize set3Points if it doesn't exist
                        if (!player.set3Points) player.set3Points = 0;
                        // For manual entry, assume full set (1.0 points) since we don't track duration
                        player.set3Points += 1.0;
                    }
                    if (index === 3) {
                        // Initialize set4Benches if it doesn't exist (for existing players)
                        if (!player.set4Benches) player.set4Benches = 0;
                        player.set4Benches++;
                        // Initialize set4Points if it doesn't exist
                        if (!player.set4Points) player.set4Points = 0;
                        // For manual entry, assume full set (1.0 points) since we don't track duration
                        player.set4Points += 1.0;
                    }
                    // Only count towards total if not a late arrival in Set 1
                    if (index !== 0 || !set.arrivedLate) {
                        player.totalBenches++;
                    }
                }
            });

            // Save updated players
            await saveToStore('players', { id: 'playerList', players: players });

            // Save week
            await saveToStore('weeks', weekData);

            document.getElementById('manualStatus').innerHTML = 
                `<div class="status-success">‚úì Week ${weekNumber} saved successfully! Statistics updated.</div>`;

            // Clear form
            document.getElementById('manualWeekNumber').value = '';
            manualWeekData = {
                numberOfSets: 3,
                set1: { bench: null, team1: null, team2: null, winners: null, arrivedLate: false },
                set2: { bench: null, team1: null, team2: null, winners: null },
                set3: { bench: null, team1: null, team2: null, winners: null },
                set4: { bench: null, team1: null, team2: null, winners: null }
            };

            // Reset dropdowns for all 4 sets
            for (let setNum = 1; setNum <= 4; setNum++) {
                document.getElementById(`manualSet${setNum}Bench`).value = '';
                document.getElementById(`manualSet${setNum}Winners`).innerHTML =
                    '<p style="color: #999; font-style: italic;">Select a bench player first</p>';
            }

            // Reset arrived late checkbox
            const arrivedLateCheckbox = document.getElementById('manualSet1ArrivedLate');
            if (arrivedLateCheckbox) {
                arrivedLateCheckbox.checked = false;
            }

            // Reset to 3 sets
            setManualNumberOfSets(3);

            alert(`Week ${weekNumber} saved successfully!`);
        }

        // Data export/import
        async function exportData() {
            try {
                console.log('Starting data export...');
                
                const players = await getFromStore('players', 'playerList');
                const weeks = await getAllFromStore('weeks');
                const currentWeek = await getFromStore('currentWeek', 'current');

                console.log('Export data retrieved:', {
                    players: players,
                    weeksCount: weeks ? weeks.length : 0,
                    hasCurrentWeek: !!currentWeek
                });

                // Create export data structure
                const data = {
                    version: 1,
                    exportDate: new Date().toISOString(),
                    players: players || null,
                    weeks: weeks || [],
                    currentWeek: currentWeek || null
                };

                // Show summary before export
                const playerCount = players && players.players ? players.players.length : 0;
                const weeksCount = weeks ? weeks.length : 0;
                const hasCurrentWeek = !!currentWeek;

                console.log('Exporting:', {
                    playerCount: playerCount,
                    completedWeeks: weeksCount,
                    currentWeekInProgress: hasCurrentWeek
                });

                // Create and download the file
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tennis-rotation-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                // Show detailed success message
                document.getElementById('dataStatus').innerHTML = 
                    `<div class="status-success">
                        <strong>‚úì Data exported successfully!</strong><br>
                        <small>
                            Players: ${playerCount} | 
                            Completed weeks: ${weeksCount} | 
                            Current week: ${hasCurrentWeek ? 'Yes' : 'No'}
                        </small>
                    </div>`;
                
                console.log('Export completed successfully');
            } catch (error) {
                console.error('Error exporting data:', error);
                document.getElementById('dataStatus').innerHTML = 
                    `<div class="status-warning">
                        <strong>Error exporting data:</strong><br>
                        ${error.message}
                    </div>`;
            }
        }

        async function importData(event) {
            console.log('Import data triggered');
            const file = event.target.files[0];
            
            if (!file) {
                console.log('No file selected');
                return;
            }

            console.log('File selected:', file.name, 'Size:', file.size, 'bytes');

            // Show loading message
            document.getElementById('dataStatus').innerHTML = 
                '<div class="status-info">‚è≥ Importing data, please wait...</div>';

            const reader = new FileReader();
            
            reader.onerror = () => {
                console.error('FileReader error');
                document.getElementById('dataStatus').innerHTML = 
                    '<div class="status-warning">‚ùå Error reading file. Please try again.</div>';
            };

            reader.onload = async (e) => {
                try {
                    console.log('File read successfully, parsing JSON...');
                    const data = JSON.parse(e.target.result);
                    console.log('JSON parsed successfully:', data);

                    // Validate the data structure
                    if (!data.version) {
                        throw new Error('Invalid backup file: missing version number');
                    }

                    let importedItems = {
                        players: 0,
                        weeks: 0,
                        currentWeek: false
                    };

                    // Import players
                    if (data.players) {
                        console.log('Importing players...');
                        await saveToStore('players', data.players);
                        importedItems.players = data.players.players ? data.players.players.length : 0;
                        console.log('Players imported:', importedItems.players);
                    }

                    // Import weeks
                    if (data.weeks && data.weeks.length > 0) {
                        console.log('Importing weeks...');
                        await clearStore('weeks');
                        for (let week of data.weeks) {
                            await saveToStore('weeks', week);
                            importedItems.weeks++;
                        }
                        console.log('Weeks imported:', importedItems.weeks);
                    }

                    // Import current week
                    if (data.currentWeek) {
                        console.log('Importing current week...');
                        await saveToStore('currentWeek', data.currentWeek);
                        importedItems.currentWeek = true;
                        console.log('Current week imported');
                    }

                    // Reload players into the UI
                    await loadPlayers();
                    await displayCurrentWeek();
                    
                    // Show detailed success message
                    document.getElementById('dataStatus').innerHTML = 
                        `<div class="status-success">
                            <strong>‚úì Data imported successfully!</strong><br>
                            <small>
                                Players: ${importedItems.players} | 
                                Weeks: ${importedItems.weeks} | 
                                Current week: ${importedItems.currentWeek ? 'Yes' : 'No'}
                            </small>
                        </div>`;
                    
                    console.log('Import completed successfully');
                    
                    alert(`‚úì Import successful!\n\nImported:\n‚Ä¢ ${importedItems.players} players\n‚Ä¢ ${importedItems.weeks} completed weeks\n‚Ä¢ Current week: ${importedItems.currentWeek ? 'Yes' : 'No'}`);

                } catch (error) {
                    console.error('Error importing data:', error);
                    document.getElementById('dataStatus').innerHTML = 
                        `<div class="status-warning">
                            <strong>‚ùå Error importing data:</strong><br>
                            <small>${error.message}</small><br>
                            <small>Please check the file format and try again.</small>
                        </div>`;
                    alert('Error importing data:\n\n' + error.message);
                }
            };

            reader.readAsText(file);
            event.target.value = ''; // Clear the input so same file can be selected again
        }

        async function clearAllData() {
            // First confirmation - explain what will be deleted
            const firstMessage = `This will PERMANENTLY DELETE:

‚úó All 5 player names
‚úó All player statistics (bench counts)
‚úó All completed weeks (history)
‚úó Current week in progress
‚úó EVERYTHING in the app

‚ö†Ô∏è Make sure you exported a backup first!

Click to continue to final confirmation.`;

            const firstConfirm = await showCustomConfirm(
                '‚ö†Ô∏è DANGER: CLEAR ALL DATA ‚ö†Ô∏è',
                firstMessage,
                'Continue to Final Warning',
                'Cancel',
                true
            );

            if (!firstConfirm) {
                document.getElementById('dataStatus').innerHTML = 
                    '<div class="status-info">Clear all data cancelled.</div>';
                return;
            }

            // Second confirmation - final warning
            const secondMessage = `You are about to delete ALL DATA.
This action CANNOT be undone!

Have you exported your data as backup?

Click to DELETE EVERYTHING
Click Cancel to keep your data safe`;

            const secondConfirm = await showCustomConfirm(
                'üö® FINAL WARNING üö®',
                secondMessage,
                'DELETE EVERYTHING',
                'Keep My Data Safe',
                true
            );

            if (!secondConfirm) {
                document.getElementById('dataStatus').innerHTML = 
                    '<div class="status-info">Clear all data cancelled. Your data is safe.</div>';
                return;
            }

            try {
                // Clear all stores
                await clearStore('players');
                await clearStore('weeks');
                await clearStore('currentWeek');

                // Clear player input fields
                for (let i = 1; i <= 5; i++) {
                    const input = document.getElementById(`player${i}`);
                    if (input) input.value = '';
                }

                document.getElementById('dataStatus').innerHTML = 
                    '<div class="status-success">‚úì All data cleared! The app has been reset.</div>';
                
                await displayCurrentWeek();
                
                alert('All data has been permanently deleted.\n\nYou can now set up new players in the Setup tab.');
            } catch (error) {
                console.error('Error clearing all data:', error);
                document.getElementById('dataStatus').innerHTML = 
                    '<div class="status-warning">Error clearing data: ' + error.message + '</div>';
            }
        }

        // Initialize app
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('App starting...');
            
            try {
                // Show loading state
                const setupTab = document.getElementById('setup');
                if (setupTab) {
                    const loadingDiv = document.createElement('div');
                    loadingDiv.id = 'loadingMessage';
                    loadingDiv.className = 'status-info';
                    loadingDiv.style.margin = '20px';
                    loadingDiv.textContent = 'Loading app...';
                    setupTab.insertBefore(loadingDiv, setupTab.firstChild);
                }

                await initDB();
                console.log('Database initialized');
                
                await loadPlayers();
                console.log('Players loaded');
                
                await displayCurrentWeek();
                console.log('Current week displayed');
                
                await displayStats();
                console.log('Statistics displayed');
                
                // Generate setup tab content after DB is ready
                await generateSetup();
                console.log('Setup generated');
                
                // Generate manual entry tab
                await generateManualEntry();
                console.log('Manual entry generated');
                
                // Generate data management tab
                generateDataManagement();
                console.log('Data management generated');
                
                // Remove loading message
                const loadingMsg = document.getElementById('loadingMessage');
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                
                // Show error to user
                const setupTab = document.getElementById('setup');
                if (setupTab) {
                    const loadingMsg = document.getElementById('loadingMessage');
                    if (loadingMsg) {
                        loadingMsg.remove();
                    }
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'status-warning';
                    errorDiv.style.margin = '20px';
                    errorDiv.innerHTML = `
                        <strong>Error loading app</strong><br>
                        <small>${error.message || 'Unknown error'}</small><br>
                        <small>Try refreshing the page or clearing your browser cache.</small>
                    `;
                    setupTab.insertBefore(errorDiv, setupTab.firstChild);
                }
            }
        });
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TRANSLATION SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        const translations = {
            en: {
                // Header
                app_title: "üéæ Tennis Rotation Manager",
                app_subtitle: "Fair doubles rotation for 5 players",
                
                // Navigation tabs
                tab_stats: "Statistics",
                tab_week: "Current Week",
                tab_faq: "FAQ",
                tab_history: "History",
                tab_setup: "Setup",
                tab_manual: "Historical Data",
                tab_data: "Data",
                
                // Common buttons
                btn_save: "Save",
                btn_cancel: "Cancel",
                btn_clear: "Clear",
                btn_edit: "Edit",
                btn_export: "Export",
                btn_import: "Import",
                btn_delete: "Delete",
                btn_confirm: "Confirm",
                
                // Week actions
                btn_start_week: "Start New Week",
                btn_reset_week: "Clear & Restart Week",
                btn_complete_week: "Complete Week",
                btn_lock_set: "Lock Set",
                btn_lock_set_winner: "Lock Set {0} with Winner",
                btn_lock_set_no_winner: "Lock Set {0} - No Winner (Time Limit)",
                btn_clear_set: "üóëÔ∏è Clear Set {0}",
                btn_auto_select: "Auto-Select Fair Bench",
                
                // Set labels
                set: "Set",
                set_number: "Set {0}",
                team: "Team",
                team_number: "Team {0}",
                benched: "Benched",
                winners: "Winners",
                select_bench: "Select Bench Player:",
                select_winner: "Select Winning Team",
                select_winner_optional: "Select Winning Team (Optional for Set 3):",
                
                // Player setup
                player_setup: "Player Setup",
                player_name: "Player {0}",
                edit_players: "‚úèÔ∏è Edit Players",
                save_players: "üíæ Save Players",
                player_names_required: "Please enter all 5 player names",
                players_saved: "‚úì Players saved successfully!",
                
                // Statistics
                statistics: "Statistics",
                rank: "Rank",
                player: "PLAYER",
                set1_benches: "SET<br>1",
                set2_benches: "SET<br>2",
                set3_benches: "SET<br>3",
                set4_benches: "SET<br>4",
                total_benches: "TOTAL",
                points: "POINTS",
                visual: "VISUAL",
                no_stats: "No player statistics available yet. Add players in the Setup tab.",
                
                // Scoring system
                scoring_system: "Weighted Scoring System:",
                set1_points_info: "Set 1 benches: <strong>1.0 point</strong> each",
                set2_points_info: "Set 2 benches: <strong>1.0 point</strong> each",
                set3_points_info: "Set 3 benches: <strong>Variable points</strong> based on duration played",
                set3_full: "‚Ä¢ Full set: 1.0 point",
                set3_two_thirds: "‚Ä¢ 2/3 set: 0.8 points",
                set3_less_half: "‚Ä¢ Less than half: 0.6 points",
                set4_points_info: "Set 4 benches: <strong>Variable points</strong> based on duration played (optional set)",
                set4_full: "‚Ä¢ Full set: 1.0 point",
                set4_two_thirds: "‚Ä¢ 2/3 set: 0.8 points",
                set4_less_half: "‚Ä¢ Less than half: 0.6 points",
                late_arrival_info: "<strong>Late Arrival:</strong> If Set 1 bench player arrives late and doesn't actually sit, mark the checkbox - they receive <strong>0 points</strong>",
                points_column_info: "<strong>Points Column:</strong> Shows the weighted score for each player. Higher points = more benched.",
                scoring_example: "<strong>Example:</strong> 1 Set 1 bench = 1.0 pts, 1 Set 2 bench = 1.0 pts, 1 Set 3 bench (full) = 1.0 pts, 1 Set 4 bench (2/3) = 0.8 pts",
                ranking_info: "<strong>Ranking:</strong> Players ranked by highest weighted score first (most benched at top)",
                
                // Set 3 duration
                set3_duration: "Set 3 Duration Played:",
                duration_full: "Full Set (1.0 pt)",
                duration_two_thirds: "2/3 Set (0.8 pts)",
                duration_less_half: "Less than Half (0.6 pts)",
                
                // Messages and status
                msg_no_players: "No players configured. Please go to Setup tab to add players.",
                msg_no_active_week: "No active week. Start a new week to begin.",
                msg_week_in_progress: "Week {0} - In Progress",
                msg_set_locked: "‚úì Set locked",
                msg_no_winner_time: " - No winner (time limit)",
                msg_select_winner_first: "Please select a winning team before locking this set.",
                msg_no_active_week_reset: "No active week to reset.",
                msg_week_reset_success: "Week reset completed successfully",
                
                // Current Week - Teams on court
                teams_on_court: "Teams on Court:",
                
                // History
                history_title: "Completed Weeks History",
                no_history: "No completed weeks yet. Complete a week to see it here.",
                week_number: "Week {0}",
                completed_on: "Completed on {0}",
                
                // Historical Data
                manual_entry_title: "Add Historical Week Data",
                manual_entry_desc: "Use this to manually enter results from past weeks that were played before using this app.",
                week_to_add: "Week to Add:",
                add_week_data: "Add Week Data",
                week_added_success: "‚úì Week {0} data added successfully!",
                
                // Data Management
                data_management: "Data Management",
                export_title: "Export Data",
                export_desc: "Download all your data as a backup JSON file",
                export_all: "Export All Data",
                import_title: "Import Data",
                import_desc: "Restore data from a previously exported JSON file",
                import_file: "Import Data from File",
                choose_file: "Choose File",
                clear_all_title: "Clear All Data",
                clear_all_desc: "‚ö†Ô∏è DANGER ZONE: Permanently delete all data",
                clear_all_btn: "Clear All Data",
                data_status: "Status:",
                
                // Confirmation dialogs
                confirm_clear_set_title: "‚ö†Ô∏è WARNING: Clear Set {0}?",
                confirm_clear_set_msg: "This will delete all data for Set {0}:\n\n‚Ä¢ Benched player\n‚Ä¢ Team assignments\n‚Ä¢ Winner selection\n‚Ä¢ Locked status\n\nYou will need to re-enter all information for this set.\n\nAre you sure you want to continue?",
                confirm_yes_clear: "Yes, Clear Set",
                confirm_reset_week_title: "‚ö†Ô∏è RESET WEEK {0}?",
                confirm_reset_week_msg: "This will DELETE all current data for Week {0}:\n\n‚Ä¢ All bench selections\n‚Ä¢ All team assignments\n‚Ä¢ All winner selections\n‚Ä¢ All set progress\n\nThe week will be completely reset and you'll need to start over.\n\nAre you sure you want to continue?",
                confirm_yes_restart: "Yes, Clear & Restart",
                confirm_clear_all_title: "‚ö†Ô∏è DANGER: CLEAR ALL DATA ‚ö†Ô∏è",
                confirm_clear_all_first: "This will PERMANENTLY DELETE:\n\n‚úó All 5 player names\n‚úó All player statistics (bench counts)\n‚úó All completed weeks (history)\n‚úó Current week in progress\n‚úó EVERYTHING in the app\n\n‚ö†Ô∏è Make sure you exported a backup first!\n\nClick to continue to final confirmation.",
                confirm_continue: "Continue to Final Warning",
                confirm_clear_all_final: "üö® FINAL WARNING üö®",
                confirm_clear_all_final_msg: "You are about to delete ALL DATA.\nThis action CANNOT be undone!\n\nHave you exported your data as backup?\n\nClick to DELETE EVERYTHING\nClick Cancel to keep your data safe",
                confirm_delete_everything: "DELETE EVERYTHING",
                confirm_keep_safe: "Keep My Data Safe",
                
                // Rank badges
                rank_1st: "1st",
                rank_2nd: "2nd",
                rank_3rd: "3rd",
                rank_4th: "4th",
                rank_5th: "5th",
                
                // Section titles
                section_statistics: "Bench Statistics",
                section_history: "Match History",
                section_setup: "Player Setup",
                section_data: "Data Management",
                section_weekly_match: "Weekly Match",
                section_faq: "Frequently Asked Questions (FAQ)",
                
                // Current Week - Team building
                build_teams: "Build Teams (Click players to assign):",
                team_1: "Team 1",
                team_2: "Team 2",
                click_2_players: "Click 2 players below",
                available_players: "Available Players (click to add to Team 1 or Team 2):",
                all_assigned: "‚úì All players assigned!",
                teams_on_court: "Teams on Court:",
                
                // History
                week: "Week",
                result: "Result",
                no_winner_time_limit: "No winner (time limit)",
                bench: "Bench",
                
                // Setup tab
                player_label: "Player",
                enter_name: "Enter name",
                enter_all_names: "Please enter all 5 player names",
                players_saved_success: "‚úì Players saved successfully!",
                
                // Historical Data tab
                section_historical_data: "Add Historical Week Data",
                historical_data_desc: "Use this form to manually enter data from previous weeks. This will update player statistics and improve future recommendations.",
                week_number: "Week Number",
                week_hash: "Week #",
                enter_week_number: "Enter week number",
                bench_player: "Bench Player",
                winning_team: "Winning Team",
                select_player: "Select player...",
                save_historical_week: "üíæ Save Historical Week",
                
                // Data Management tab
                section_data_management: "Data Management",
                data_management_desc: "Your data is automatically saved in your browser's IndexedDB. Use these tools to backup or restore your data.",
                export_data_json: "üì• Export Data (JSON)",
                import_data_json: "üì§ Import Data (JSON)",
                clear_all_data_btn: "üóëÔ∏è Clear All Data",
            },
            ro: {
                // Header
                app_title: "üéæ Manager Rota»õie Tenis",
                app_subtitle: "Rota»õie echitabilƒÉ dublu pentru 5 jucƒÉtori",
                
                // Navigation tabs
                tab_stats: "Statistici",
                tab_week: "SƒÉptƒÉm√¢na CurentƒÉ",
                tab_faq: "√éntrebƒÉri Frecvente",
                tab_history: "Istoric",
                tab_setup: "Configurare",
                tab_manual: "Date Istorice",
                tab_data: "Date",
                
                // Common buttons
                btn_save: "SalveazƒÉ",
                btn_cancel: "AnuleazƒÉ",
                btn_clear: "»òterge",
                btn_edit: "EditeazƒÉ",
                btn_export: "ExportƒÉ",
                btn_import: "ImportƒÉ",
                btn_delete: "»òterge",
                btn_confirm: "ConfirmƒÉ",
                
                // Week actions
                btn_start_week: "√éncepe SƒÉptƒÉm√¢nƒÉ NouƒÉ",
                btn_reset_week: "»òterge »ôi Reporne»ôte SƒÉptƒÉm√¢na",
                btn_complete_week: "FinalizeazƒÉ SƒÉptƒÉm√¢na",
                btn_lock_set: "BlocheazƒÉ Setul",
                btn_lock_set_winner: "BlocheazƒÉ Setul {0} cu C√¢»ôtigƒÉtor",
                btn_lock_set_no_winner: "BlocheazƒÉ Setul {0} - FƒÉrƒÉ C√¢»ôtigƒÉtor (LimitƒÉ Timp)",
                btn_clear_set: "üóëÔ∏è »òterge Setul {0}",
                btn_auto_select: "Selectare AutomatƒÉ EchitabilƒÉ",
                
                // Set labels
                set: "Setul",
                set_number: "Setul {0}",
                team: "Echipa",
                team_number: "Echipa {0}",
                benched: "RezervƒÉ",
                winners: "C√¢»ôtigƒÉtori",
                select_bench: "SelecteazƒÉ JucƒÉtor RezervƒÉ:",
                select_winner: "SelecteazƒÉ Echipa C√¢»ôtigƒÉtoare",
                select_winner_optional: "SelecteazƒÉ Echipa C√¢»ôtigƒÉtoare (Op»õional pentru Setul 3):",
                
                // Player setup
                player_setup: "Configurare JucƒÉtori",
                player_name: "JucƒÉtor {0}",
                edit_players: "‚úèÔ∏è EditeazƒÉ JucƒÉtori",
                save_players: "üíæ SalveazƒÉ JucƒÉtori",
                player_names_required: "Te rog introdu toate cele 5 nume de jucƒÉtori",
                players_saved: "‚úì JucƒÉtori salva»õi cu succes!",
                
                // Statistics
                statistics: "Statistici",
                rank: "Rang",
                player: "JUCƒÇTOR",
                set1_benches: "SET<br>1",
                set2_benches: "SET<br>2",
                set3_benches: "SET<br>3",
                set4_benches: "SET<br>4",
                total_benches: "TOTAL",
                points: "PUNCTE",
                visual: "VIZUAL",
                no_stats: "√éncƒÉ nu existƒÉ statistici. AdaugƒÉ jucƒÉtori √Æn tab-ul Configurare.",
                
                // Scoring system
                scoring_system: "Sistem de Punctare Ponderat:",
                set1_points_info: "Rezerve Set 1: <strong>1.0 punct</strong> fiecare",
                set2_points_info: "Rezerve Set 2: <strong>1.0 punct</strong> fiecare",
                set3_points_info: "Rezerve Set 3: <strong>Puncte variabile</strong> bazat pe durata jucatƒÉ",
                set3_full: "‚Ä¢ Set complet: 1.0 punct",
                set3_two_thirds: "‚Ä¢ 2/3 set: 0.8 puncte",
                set3_less_half: "‚Ä¢ Mai pu»õin de jumƒÉtate: 0.6 puncte",
                set4_points_info: "Rezerve Set 4: <strong>Puncte variabile</strong> bazat pe durata jucatƒÉ (set op»õional)",
                set4_full: "‚Ä¢ Set complet: 1.0 punct",
                set4_two_thirds: "‚Ä¢ 2/3 set: 0.8 puncte",
                set4_less_half: "‚Ä¢ Mai pu»õin de jumƒÉtate: 0.6 puncte",
                late_arrival_info: "<strong>√ént√¢rziere:</strong> DacƒÉ jucƒÉtorul rezervƒÉ Set 1 ajunge t√¢rziu »ôi nu stƒÉ efectiv pe bancƒÉ, bifeazƒÉ caseta - prime»ôte <strong>0 puncte</strong>",
                points_column_info: "<strong>Coloana Puncte:</strong> AratƒÉ scorul ponderat pentru fiecare jucƒÉtor. Puncte mai mari = mai mult pe bancƒÉ.",
                scoring_example: "<strong>Exemplu:</strong> 1 rezervƒÉ Set 1 = 1.0 pct, 1 rezervƒÉ Set 2 = 1.0 pct, 1 rezervƒÉ Set 3 (complet) = 1.0 pct, 1 rezervƒÉ Set 4 (2/3) = 0.8 pct",
                ranking_info: "<strong>Clasament:</strong> JucƒÉtori clasa»õi dupƒÉ cel mai mare scor ponderat (cei mai mult pe bancƒÉ √Æn top)",
                
                // Set 3 duration
                set3_duration: "Durata Setului 3 Jucat:",
                duration_full: "Set Complet (1.0 pt)",
                duration_two_thirds: "2/3 Set (0.8 pct)",
                duration_less_half: "Mai Pu»õin de JumƒÉtate (0.6 pct)",
                
                // Messages and status
                msg_no_players: "Niciun jucƒÉtor configurat. Mergi la tab-ul Configurare pentru a adƒÉuga jucƒÉtori.",
                msg_no_active_week: "Nicio sƒÉptƒÉm√¢nƒÉ activƒÉ. √éncepe o sƒÉptƒÉm√¢nƒÉ nouƒÉ.",
                msg_week_in_progress: "SƒÉptƒÉm√¢na {0} - √én DesfƒÉ»ôurare",
                msg_set_locked: "‚úì Set blocat",
                msg_no_winner_time: " - FƒÉrƒÉ c√¢»ôtigƒÉtor (limitƒÉ timp)",
                msg_select_winner_first: "Te rog selecteazƒÉ o echipƒÉ c√¢»ôtigƒÉtoare √Ænainte de a bloca setul.",
                msg_no_active_week_reset: "Nicio sƒÉptƒÉm√¢nƒÉ activƒÉ de resetat.",
                msg_week_reset_success: "Resetare sƒÉptƒÉm√¢nƒÉ finalizatƒÉ cu succes",
                
                // Current Week - Teams on court
                teams_on_court: "Echipe pe Teren:",
                
                // History
                history_title: "Istoric SƒÉptƒÉm√¢ni Completate",
                no_history: "√éncƒÉ nu existƒÉ sƒÉptƒÉm√¢ni completate. FinalizeazƒÉ o sƒÉptƒÉm√¢nƒÉ pentru a o vedea aici.",
                week_number: "SƒÉptƒÉm√¢na {0}",
                completed_on: "CompletatƒÉ pe {0}",
                
                // Historical Data
                manual_entry_title: "AdaugƒÉ Date SƒÉptƒÉm√¢nƒÉ IstoricƒÉ",
                manual_entry_desc: "Folose»ôte pentru a introduce manual rezultate din sƒÉptƒÉm√¢nile anterioare jucate √Ænainte de a folosi aplica»õia.",
                week_to_add: "SƒÉptƒÉm√¢na de AdƒÉugat:",
                add_week_data: "AdaugƒÉ Date SƒÉptƒÉm√¢nƒÉ",
                week_added_success: "‚úì Datele sƒÉptƒÉm√¢nii {0} au fost adƒÉugate cu succes!",
                
                // Data Management
                data_management: "Gestionare Date",
                export_title: "ExportƒÉ Date",
                export_desc: "DescarcƒÉ toate datele ca fi»ôier JSON de backup",
                export_all: "ExportƒÉ Toate Datele",
                import_title: "ImportƒÉ Date",
                import_desc: "RestaureazƒÉ date dintr-un fi»ôier JSON exportat anterior",
                import_file: "ImportƒÉ Date din Fi»ôier",
                choose_file: "Alege Fi»ôier",
                clear_all_title: "»òterge Toate Datele",
                clear_all_desc: "‚ö†Ô∏è ZONƒÇ PERICULOASƒÇ: »òterge permanent toate datele",
                clear_all_btn: "»òterge Toate Datele",
                data_status: "Status:",
                
                // Confirmation dialogs
                confirm_clear_set_title: "‚ö†Ô∏è ATEN»öIE: »òterge Setul {0}?",
                confirm_clear_set_msg: "Aceasta va »ôterge toate datele pentru Setul {0}:\n\n‚Ä¢ JucƒÉtor rezervƒÉ\n‚Ä¢ Repartizarea echipelor\n‚Ä¢ Selec»õia c√¢»ôtigƒÉtorului\n‚Ä¢ Status blocat\n\nVa trebui sƒÉ reintroduci toate informa»õiile pentru acest set.\n\nE»ôti sigur cƒÉ vrei sƒÉ continui?",
                confirm_yes_clear: "Da, »òterge Setul",
                confirm_reset_week_title: "‚ö†Ô∏è RESETEAZƒÇ SƒÇPTƒÇM√ÇNA {0}?",
                confirm_reset_week_msg: "Aceasta va »òTERGE toate datele curente pentru SƒÉptƒÉm√¢na {0}:\n\n‚Ä¢ Toate selec»õiile de rezerve\n‚Ä¢ Toate repartizƒÉrile de echipe\n‚Ä¢ Toate selec»õiile de c√¢»ôtigƒÉtori\n‚Ä¢ Tot progresul seturilor\n\nSƒÉptƒÉm√¢na va fi complet resetatƒÉ »ôi va trebui sƒÉ o √Æncepi de la zero.\n\nE»ôti sigur cƒÉ vrei sƒÉ continui?",
                confirm_yes_restart: "Da, »òterge »ôi Reporne»ôte",
                confirm_clear_all_title: "‚ö†Ô∏è PERICOL: »òTERGE TOATE DATELE ‚ö†Ô∏è",
                confirm_clear_all_first: "Aceasta va »òTERGE PERMANENT:\n\n‚úó Toate cele 5 nume de jucƒÉtori\n‚úó Toate statisticile jucƒÉtorilor\n‚úó Toate sƒÉptƒÉm√¢nile completate (istoric)\n‚úó SƒÉptƒÉm√¢na curentƒÉ √Æn desfƒÉ»ôurare\n‚úó TOT din aplica»õie\n\n‚ö†Ô∏è AsigurƒÉ-te cƒÉ ai exportat un backup mai √Ænt√¢i!\n\nApasƒÉ pentru a continua la confirmarea finalƒÉ.",
                confirm_continue: "ContinuƒÉ la Avertismentul Final",
                confirm_clear_all_final: "üö® AVERTISMENT FINAL üö®",
                confirm_clear_all_final_msg: "E»ôti pe cale sƒÉ »ôtergi TOATE DATELE.\nAceastƒÉ ac»õiune NU POATE FI ANULATƒÇ!\n\nAi exportat datele ca backup?\n\nApasƒÉ pentru a »òTERGE TOT\nApasƒÉ AnuleazƒÉ pentru a pƒÉstra datele √Æn siguran»õƒÉ",
                confirm_delete_everything: "»òTERGE TOT",
                confirm_keep_safe: "PƒÉstreazƒÉ Datele Mele √Æn Siguran»õƒÉ",
                
                // Rank badges
                rank_1st: "1",
                rank_2nd: "2",
                rank_3rd: "3",
                rank_4th: "4",
                rank_5th: "5",
                
                // Section titles
                section_statistics: "Statistici Rezerve",
                section_history: "Istoric Meciuri",
                section_setup: "Configurare JucƒÉtori",
                section_data: "Gestionare Date",
                section_weekly_match: "Meci SƒÉptƒÉm√¢nal",
                section_faq: "√éntrebƒÉri Frecvente (FAQ)",
                
                // Current Week - Team building
                build_teams: "Construie»ôte Echipele (Click pe jucƒÉtori pentru a repartiza):",
                team_1: "Echipa 1",
                team_2: "Echipa 2",
                click_2_players: "Click pe 2 jucƒÉtori mai jos",
                available_players: "JucƒÉtori Disponibili (click pentru a adƒÉuga la Echipa 1 sau 2):",
                all_assigned: "‚úì To»õi jucƒÉtorii repartiza»õi!",
                teams_on_court: "Echipe pe Teren:",
                
                // History
                week: "SƒÉptƒÉm√¢na",
                result: "Rezultat",
                no_winner_time_limit: "FƒÉrƒÉ c√¢»ôtigƒÉtor (limitƒÉ timp)",
                bench: "RezervƒÉ",
                
                // Setup tab
                player_label: "JucƒÉtor",
                enter_name: "Introdu nume",
                enter_all_names: "Te rog introdu toate cele 5 nume de jucƒÉtori",
                players_saved_success: "‚úì JucƒÉtori salva»õi cu succes!",
                
                // Historical Data tab
                section_historical_data: "AdaugƒÉ Date SƒÉptƒÉm√¢nƒÉ IstoricƒÉ",
                historical_data_desc: "Folose»ôte acest formular pentru a introduce manual date din sƒÉptƒÉm√¢nile anterioare. Acest lucru va actualiza statisticile jucƒÉtorilor »ôi va √ÆmbunƒÉtƒÉ»õi recomandƒÉrile viitoare.",
                week_number: "NumƒÉr SƒÉptƒÉm√¢nƒÉ",
                week_hash: "SƒÉpt. #",
                enter_week_number: "Introdu numƒÉrul sƒÉptƒÉm√¢nii",
                bench_player: "JucƒÉtor RezervƒÉ",
                winning_team: "Echipa C√¢»ôtigƒÉtoare",
                select_player: "SelecteazƒÉ jucƒÉtor...",
                save_historical_week: "üíæ SalveazƒÉ SƒÉptƒÉm√¢na IstoricƒÉ",
                
                // Data Management tab
                section_data_management: "Gestionare Date",
                data_management_desc: "Datele tale sunt salvate automat √Æn IndexedDB-ul browserului. Folose»ôte aceste unelte pentru a face backup sau restaura datele tale.",
                export_data_json: "üì• ExportƒÉ Date (JSON)",
                import_data_json: "üì§ ImportƒÉ Date (JSON)",
                clear_all_data_btn: "üóëÔ∏è »òterge Toate Datele",
            }
        };
        
        // Get current language (default to English)
        let currentLang = localStorage.getItem('appLanguage') || 'en';
        
        // Apply translations to page
        function applyTranslations() {
            // Update all elements with data-translate attribute
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[currentLang][key]) {
                    element.innerHTML = translations[currentLang][key];
                }
            });
            
            // Update language toggle styling
            const langOptions = document.querySelectorAll('.lang-option');
            langOptions.forEach(option => {
                const lang = option.getAttribute('data-lang');
                if (lang === currentLang) {
                    // Active language - purple background
                    option.style.background = '#667eea';
                    option.style.color = '#fff';
                } else {
                    // Inactive language - transparent with gray text
                    option.style.background = 'transparent';
                    option.style.color = '#a0aec0';
                }
            });
            
            // Refresh dynamic content if currently visible
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                if (activeTab.id === 'history') {
                    displayHistory();
                } else if (activeTab.id === 'setup') {
                    generateSetup();
                } else if (activeTab.id === 'manual') {
                    generateManualEntry();
                } else if (activeTab.id === 'data') {
                    generateDataManagement();
                }
            }
            
            // Note: Dynamic content translation will be handled by individual functions
            // when they render content using the t() helper function
        }
        
        // Toggle language
        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ro' : 'en';
            localStorage.setItem('appLanguage', currentLang);
            applyTranslations();
            generateFAQ(); // Regenerate FAQ with new language
        }
        
        // Helper function to get translated text
        function t(key, ...args) {
            let text = translations[currentLang][key] || translations['en'][key] || key;
            // Replace placeholders {0}, {1}, etc. with arguments
            args.forEach((arg, index) => {
                text = text.replace(`{${index}}`, arg);
            });
            return text;
        }
        
        // FAQ Content Generator
        function generateFAQ() {
            const faqContent = {
                en: `
                    <div style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin-top: 0;">üìä Scoring System</h3>
                        
                        <h4 style="margin-top: 20px;">Q: How are points calculated?</h4>
                        <p><strong>A:</strong> Players accumulate points each time they sit on the bench:</p>
                        <ul style="line-height: 1.8;">
                            <li><strong>Set 1:</strong> 1.0 point per bench (unless marked as "arrived late")</li>
                            <li><strong>Set 2:</strong> 1.0 point per bench</li>
                            <li><strong>Set 3:</strong> Variable points based on duration played:
                                <ul style="margin-top: 5px;">
                                    <li>Full set: 1.0 point</li>
                                    <li>2/3 set: 0.8 points</li>
                                    <li>Less than half: 0.6 points</li>
                                </ul>
                            </li>
                            <li><strong>Set 4 (Optional):</strong> Variable points based on duration played:
                                <ul style="margin-top: 5px;">
                                    <li>Full set: 1.0 point</li>
                                    <li>2/3 set: 0.8 points</li>
                                    <li>Less than half: 0.6 points</li>
                                </ul>
                            </li>
                        </ul>
                        
                        <h4 style="margin-top: 20px;">Q: What does "Lower points = more deserving to bench" mean?</h4>
                        <p><strong>A:</strong> Players with fewer total points have sat on the bench less overall, so they're more deserving to sit next. The system prioritizes fairness by rotating bench duty among all players.</p>
                    </div>

                    <div style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin-top: 0;">üéØ Ranking & Priority System</h3>
                        
                        <h4 style="margin-top: 20px;">Q: How are players ranked for bench selection?</h4>
                        <p><strong>A:</strong> The system uses a multi-level priority system:</p>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0;">
                            <strong>Priority 0 (LOWEST - Last Option):</strong><br>
                            Players who already sat on the bench earlier TODAY automatically become the last option (5th choice) for subsequent sets. We strongly avoid having players bench twice in the same day.
                        </div>
                        
                        <div style="background: #e8ecff; padding: 15px; border-radius: 6px; margin: 15px 0; border-left: 4px solid #667eea;">
                            <strong>Special Rule - Winners Who Are Behind:</strong><br>
                            If a player WON a previous set today AND is 1+ points behind another specific player, they get priority ONLY over that specific player they're behind.<br><br>
                            <em>Example: Player A (winner, 2.5 pts) is 1.7 points behind Player B (4.2 pts) ‚Üí Player A ranks ahead of Player B specifically, but not ahead of players with fewer points.</em>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0;">
                            <strong>Priority 1 - Weighted Points:</strong><br>
                            Lower total points = higher priority to bench next
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0;">
                            <strong>Priority 2 - Set-Specific History:</strong><br>
                            If two players have equal points, the one with fewer benches in that specific set gets priority<br>
                            <em>Example: For Set 2 selection, prefer the player with fewer Set 2 benches historically</em>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0;">
                            <strong>Priority 3 - Total Benches:</strong><br>
                            If still tied, prefer player with fewer total benches overall
                        </div>
                        
                        <h4 style="margin-top: 20px;">Q: Example ranking scenario?</h4>
                        <p><strong>After Set 1 with these scores:</strong></p>
                        <ul style="line-height: 1.8;">
                            <li>Player 1: 3.4 pts (lost set 1)</li>
                            <li>Player 2: 2.5 pts (won set 1)</li>
                            <li>Player 3: 4.2 pts (lost set 1)</li>
                            <li>Player 4: 1.0 pt (won set 1)</li>
                            <li>Player 5: 2.6 pts (benched set 1)</li>
                        </ul>
                        <p><strong>Ranking for Set 2 bench:</strong></p>
                        <ol style="line-height: 1.8;">
                            <li><strong>Player 4</strong> (1.0 pt) - Lowest points overall</li>
                            <li><strong>Player 1</strong> (3.4 pts) - Lower than Player 3</li>
                            <li><strong>Player 2</strong> (2.5 pts) - Winner 1.7 pts behind Player 3, gets priority over P3</li>
                            <li><strong>Player 3</strong> (4.2 pts) - Highest points</li>
                            <li><strong>Player 5</strong> (2.6 pts) - Already benched = Last option</li>
                        </ol>
                    </div>

                    <div style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin-top: 0;">‚öôÔ∏è Using the App</h3>
                        
                        <h4 style="margin-top: 20px;">Q: What if the Set 1 bench player arrives late?</h4>
                        <p><strong>A:</strong> If the Set 1 bench player arrives late and doesn't actually sit on the bench for that set, check the "Player arrived late (no points awarded)" checkbox that appears after selecting the bench player. This ensures they receive <strong>0 points</strong> for that set, maintaining fairness in the rotation system.</p>

                        <h4 style="margin-top: 20px;">Q: Can I play 4 sets instead of 3?</h4>
                        <p><strong>A:</strong> Yes! After locking Set 2, you'll see toggle buttons to choose between 3 or 4 sets for the day. The 4th set is optional and works just like Set 3:</p>
                        <ul style="line-height: 1.8;">
                            <li>Select a bench player</li>
                            <li>Build the two teams</li>
                            <li>Play the set and select winner (optional if time limit)</li>
                            <li>Choose duration played (Full/2/3/Less than half) for variable points</li>
                        </ul>
                        <p>You can switch between 3-set and 4-set modes before starting Set 3.</p>

                        <h4 style="margin-top: 20px;">Q: How do I start a new week?</h4>
                        <p><strong>A:</strong> Go to the <strong>Current Week</strong> tab and click "Start New Week". The app will guide you through bench selection, team assignment, and winner selection for each set (3 or 4 sets depending on your choice).</p>
                        
                        <h4 style="margin-top: 20px;">Q: Can I change data after selecting a winner?</h4>
                        <p><strong>A:</strong> Yes! Click the "üóëÔ∏è Clear Set" button that appears for any set with data. You'll get a warning confirmation before clearing.</p>
                        
                        <h4 style="margin-top: 20px;">Q: What if Set 3 or Set 4 ends early due to time?</h4>
                        <p><strong>A:</strong> Before selecting the winner for Set 3 or Set 4, choose the duration played:
                            <ul style="margin-top: 5px; line-height: 1.8;">
                                <li><strong>Full Set:</strong> Complete set played (1.0 point)</li>
                                <li><strong>2/3 Set:</strong> About two-thirds played (0.8 points)</li>
                                <li><strong>Less than Half:</strong> Less than half played (0.6 points)</li>
                            </ul>
                            This ensures fair point allocation based on actual bench time. Both Set 3 and Set 4 support variable points and can end without a winner due to time constraints.
                        </p>
                        
                        <h4 style="margin-top: 20px;">Q: How do I view history?</h4>
                        <p><strong>A:</strong> Check the <strong>History</strong> tab to see all completed weeks, including bench assignments and winners for each set.</p>
                        
                        <h4 style="margin-top: 20px;">Q: Can I add historical data from previous weeks?</h4>
                        <p><strong>A:</strong> Yes! Use the <strong>Historical Data</strong> tab to manually enter results from past weeks. This will update player statistics and improve future recommendations.</p>
                    </div>

                    <div style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin-top: 0;">üíæ Data Management</h3>
                        
                        <h4 style="margin-top: 20px;">Q: Is my data saved automatically?</h4>
                        <p><strong>A:</strong> Yes! All data is automatically saved in your browser's local storage. Your data persists between sessions.</p>
                        
                        <h4 style="margin-top: 20px;">Q: Can I backup my data?</h4>
                        <p><strong>A:</strong> Yes! Go to the <strong>Data</strong> tab and click "Export All Data" to download a JSON backup file. You can later import it using "Import Data from File".</p>
                        
                        <h4 style="margin-top: 20px;">Q: What if I switch browsers or devices?</h4>
                        <p><strong>A:</strong> Export your data from the original browser/device and import it on the new one. Data is stored locally per browser, not in the cloud.</p>
                        
                        <h4 style="margin-top: 20px;">Q: How do I reset everything?</h4>
                        <p><strong>A:</strong> In the <strong>Data</strong> tab, use "Clear All Data" button. ‚ö†Ô∏è Make sure to export a backup first - this action cannot be undone!</p>
                    </div>

                    <div style="background: #e8ecff; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea;">
                        <p style="margin: 0;"><strong>üí° Tip:</strong> The ranking system is designed to ensure maximum fairness. Trust the algorithm - it considers all historical data and current week context to make the fairest recommendations!</p>
                    </div>
                `,
                ro: `
                    <div style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin-top: 0;">üìä Sistem de Punctare</h3>
                        
                        <h4 style="margin-top: 20px;">√é: Cum se calculeazƒÉ punctele?</h4>
                        <p><strong>R:</strong> JucƒÉtorii acumuleazƒÉ puncte de fiecare datƒÉ c√¢nd stau pe bancƒÉ:</p>
                        <ul style="line-height: 1.8;">
                            <li><strong>Set 1:</strong> 1.0 punct per rezervƒÉ (dacƒÉ nu este marcat ca "ajuns t√¢rziu")</li>
                            <li><strong>Set 2:</strong> 1.0 punct per rezervƒÉ</li>
                            <li><strong>Set 3:</strong> Puncte variabile bazate pe durata jucatƒÉ:
                                <ul style="margin-top: 5px;">
                                    <li>Set complet: 1.0 punct</li>
                                    <li>2/3 set: 0.8 puncte</li>
                                    <li>Mai pu»õin de jumƒÉtate: 0.6 puncte</li>
                                </ul>
                            </li>
                            <li><strong>Set 4 (Op»õional):</strong> Puncte variabile bazate pe durata jucatƒÉ:
                                <ul style="margin-top: 5px;">
                                    <li>Set complet: 1.0 punct</li>
                                    <li>2/3 set: 0.8 puncte</li>
                                    <li>Mai pu»õin de jumƒÉtate: 0.6 puncte</li>
                                </ul>
                            </li>
                        </ul>
                        
                        <h4 style="margin-top: 20px;">√é: Ce √ÆnseamnƒÉ "Puncte mai mici = mai merituos sƒÉ fie rezervƒÉ"?</h4>
                        <p><strong>R:</strong> JucƒÉtorii cu mai pu»õine puncte totale au stat mai pu»õin pe bancƒÉ √Æn total, deci meritƒÉ mai mult sƒÉ stea urmƒÉtorii. Sistemul prioritizeazƒÉ echitatea prin rota»õia √Ændatoririlor de rezervƒÉ √Æntre to»õi jucƒÉtorii.</p>
                    </div>

                    <div style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin-top: 0;">üéØ Sistem de Clasare & PrioritƒÉ»õi</h3>
                        
                        <h4 style="margin-top: 20px;">√é: Cum sunt clasa»õi jucƒÉtorii pentru selec»õia rezervei?</h4>
                        <p><strong>R:</strong> Sistemul folose»ôte un sistem de prioritƒÉ»õi multi-nivel:</p>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0;">
                            <strong>Prioritatea 0 (CEA MAI MICƒÇ - Ultima Op»õiune):</strong><br>
                            JucƒÉtorii care au stat deja pe bancƒÉ ASTƒÇZI devin automat ultima op»õiune (a 5-a alegere) pentru seturile urmƒÉtoare. EvitƒÉm puternic ca jucƒÉtorii sƒÉ fie rezervƒÉ de douƒÉ ori √Æn aceea»ôi zi.
                        </div>
                        
                        <div style="background: #e8ecff; padding: 15px; border-radius: 6px; margin: 15px 0; border-left: 4px solid #667eea;">
                            <strong>RegulƒÉ SpecialƒÉ - C√¢»ôtigƒÉtori Care Sunt √én UrmƒÉ:</strong><br>
                            DacƒÉ un jucƒÉtor a C√Ç»òTIGAT un set anterior astƒÉzi »òI este cu 1+ puncte √Æn urmƒÉ fa»õƒÉ de un alt jucƒÉtor specific, prime»ôte prioritate DOAR fa»õƒÉ de acel jucƒÉtor specific.<br><br>
                            <em>Exemplu: JucƒÉtorul A (c√¢»ôtigƒÉtor, 2.5 pct) este cu 1.7 puncte √Æn urmƒÉ fa»õƒÉ de JucƒÉtorul B (4.2 pct) ‚Üí JucƒÉtorul A se claseazƒÉ √Ænaintea JucƒÉtorului B √Æn mod specific, dar nu √Ænaintea jucƒÉtorilor cu mai pu»õine puncte.</em>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0;">
                            <strong>Prioritatea 1 - Puncte Ponderate:</strong><br>
                            Puncte totale mai mici = prioritate mai mare pentru rezervƒÉ
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0;">
                            <strong>Prioritatea 2 - Istoric Specific Setului:</strong><br>
                            DacƒÉ doi jucƒÉtori au puncte egale, cel cu mai pu»õine rezerve √Æn acel set specific prime»ôte prioritate<br>
                            <em>Exemplu: Pentru selec»õia Setului 2, preferƒÉ jucƒÉtorul cu mai pu»õine rezerve Set 2 istoric</em>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0;">
                            <strong>Prioritatea 3 - Total Rezerve:</strong><br>
                            DacƒÉ √ÆncƒÉ egal, preferƒÉ jucƒÉtorul cu mai pu»õine rezerve totale √Æn general
                        </div>
                        
                        <h4 style="margin-top: 20px;">√é: Scenariu exemplu de clasare?</h4>
                        <p><strong>DupƒÉ Setul 1 cu aceste scoruri:</strong></p>
                        <ul style="line-height: 1.8;">
                            <li>JucƒÉtor 1: 3.4 pct (pierdut setul 1)</li>
                            <li>JucƒÉtor 2: 2.5 pct (c√¢»ôtigat setul 1)</li>
                            <li>JucƒÉtor 3: 4.2 pct (pierdut setul 1)</li>
                            <li>JucƒÉtor 4: 1.0 pct (c√¢»ôtigat setul 1)</li>
                            <li>JucƒÉtor 5: 2.6 pct (rezervƒÉ setul 1)</li>
                        </ul>
                        <p><strong>Clasament pentru rezerva Setului 2:</strong></p>
                        <ol style="line-height: 1.8;">
                            <li><strong>JucƒÉtor 4</strong> (1.0 pct) - Cele mai pu»õine puncte √Æn total</li>
                            <li><strong>JucƒÉtor 1</strong> (3.4 pct) - Mai pu»õin dec√¢t JucƒÉtorul 3</li>
                            <li><strong>JucƒÉtor 2</strong> (2.5 pct) - C√¢»ôtigƒÉtor cu 1.7 pct √Æn urmƒÉ fa»õƒÉ de JucƒÉtorul 3, prime»ôte prioritate fa»õƒÉ de J3</li>
                            <li><strong>JucƒÉtor 3</strong> (4.2 pct) - Cele mai multe puncte</li>
                            <li><strong>JucƒÉtor 5</strong> (2.6 pct) - Deja rezervƒÉ = Ultima op»õiune</li>
                        </ol>
                    </div>

                    <div style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin-top: 0;">‚öôÔ∏è Folosirea Aplica»õiei</h3>
                        
                        <h4 style="margin-top: 20px;">√é: Ce se √Ænt√¢mplƒÉ dacƒÉ jucƒÉtorul rezervƒÉ Set 1 ajunge t√¢rziu?</h4>
                        <p><strong>R:</strong> DacƒÉ jucƒÉtorul rezervƒÉ Set 1 ajunge t√¢rziu »ôi nu stƒÉ efectiv pe bancƒÉ pentru acel set, bifeazƒÉ caseta "JucƒÉtor ajuns t√¢rziu (fƒÉrƒÉ puncte acordate)" care apare dupƒÉ selectarea jucƒÉtorului rezervƒÉ. Acest lucru asigurƒÉ cƒÉ prime»ôte <strong>0 puncte</strong> pentru acel set, men»õin√¢nd echitatea √Æn sistemul de rota»õie.</p>

                        <h4 style="margin-top: 20px;">√é: Pot juca 4 seturi √Æn loc de 3?</h4>
                        <p><strong>R:</strong> Da! DupƒÉ blocarea Setului 2, vei vedea butoane de comutare pentru a alege √Æntre 3 sau 4 seturi pentru ziua respectivƒÉ. Setul 4 este op»õional »ôi func»õioneazƒÉ exact ca Setul 3:</p>
                        <ul style="line-height: 1.8;">
                            <li>SelecteazƒÉ un jucƒÉtor rezervƒÉ</li>
                            <li>Construie»ôte cele douƒÉ echipe</li>
                            <li>JoacƒÉ setul »ôi selecteazƒÉ c√¢»ôtigƒÉtorul (op»õional dacƒÉ limitƒÉ de timp)</li>
                            <li>Alege durata jucatƒÉ (Complet/2/3/Mai pu»õin de jumƒÉtate) pentru puncte variabile</li>
                        </ul>
                        <p>Po»õi comuta √Æntre modurile 3 seturi »ôi 4 seturi √Ænainte de a √Æncepe Setul 3.</p>

                        <h4 style="margin-top: 20px;">√é: Cum √Æncep o sƒÉptƒÉm√¢nƒÉ nouƒÉ?</h4>
                        <p><strong>R:</strong> Mergi la tab-ul <strong>SƒÉptƒÉm√¢na CurentƒÉ</strong> »ôi apasƒÉ "√éncepe SƒÉptƒÉm√¢nƒÉ NouƒÉ". Aplica»õia te va ghida prin selec»õia rezervei, repartizarea echipelor »ôi selec»õia c√¢»ôtigƒÉtorului pentru fiecare set (3 sau 4 seturi √Æn func»õie de alegerea ta).</p>
                        
                        <h4 style="margin-top: 20px;">√é: Pot schimba datele dupƒÉ selectarea c√¢»ôtigƒÉtorului?</h4>
                        <p><strong>R:</strong> Da! ApasƒÉ butonul "üóëÔ∏è »òterge Setul" care apare pentru orice set cu date. Vei primi o confirmare de avertizare √Ænainte de »ôtergere.</p>
                        
                        <h4 style="margin-top: 20px;">√é: Ce se √Ænt√¢mplƒÉ dacƒÉ Setul 3 sau Setul 4 se terminƒÉ devreme din cauza timpului?</h4>
                        <p><strong>R:</strong> √énainte de a selecta c√¢»ôtigƒÉtorul pentru Setul 3 sau Setul 4, alege durata jucatƒÉ:
                            <ul style="margin-top: 5px; line-height: 1.8;">
                                <li><strong>Set Complet:</strong> Set complet jucat (1.0 punct)</li>
                                <li><strong>2/3 Set:</strong> Aproximativ douƒÉ treimi jucat (0.8 puncte)</li>
                                <li><strong>Mai Pu»õin de JumƒÉtate:</strong> Mai pu»õin de jumƒÉtate jucat (0.6 puncte)</li>
                            </ul>
                            Acest lucru asigurƒÉ alocarea corectƒÉ a punctelor bazatƒÉ pe timpul efectiv pe bancƒÉ. At√¢t Setul 3, c√¢t »ôi Setul 4 suportƒÉ puncte variabile »ôi pot sƒÉ se termine fƒÉrƒÉ c√¢»ôtigƒÉtor din cauza constr√¢ngerilor de timp.
                        </p>
                        
                        <h4 style="margin-top: 20px;">√é: Cum vƒÉd istoricul?</h4>
                        <p><strong>R:</strong> VerificƒÉ tab-ul <strong>Istoric</strong> pentru a vedea toate sƒÉptƒÉm√¢nile completate, inclusiv repartizƒÉrile de rezerve »ôi c√¢»ôtigƒÉtorii pentru fiecare set.</p>
                        
                        <h4 style="margin-top: 20px;">√é: Pot adƒÉuga date istorice din sƒÉptƒÉm√¢nile anterioare?</h4>
                        <p><strong>R:</strong> Da! Folose»ôte tab-ul <strong>Date Istorice</strong> pentru a introduce manual rezultatele din sƒÉptƒÉm√¢nile trecute. Acest lucru va actualiza statisticile jucƒÉtorilor »ôi va √ÆmbunƒÉtƒÉ»õi recomandƒÉrile viitoare.</p>
                    </div>

                    <div style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin-top: 0;">üíæ Gestionarea Datelor</h3>
                        
                        <h4 style="margin-top: 20px;">√é: Datele mele sunt salvate automat?</h4>
                        <p><strong>R:</strong> Da! Toate datele sunt salvate automat √Æn memoria localƒÉ a browserului tƒÉu. Datele tale persistƒÉ √Æntre sesiuni.</p>
                        
                        <h4 style="margin-top: 20px;">√é: Pot face backup datelor mele?</h4>
                        <p><strong>R:</strong> Da! Mergi la tab-ul <strong>Date</strong> »ôi apasƒÉ "ExportƒÉ Toate Datele" pentru a descƒÉrca un fi»ôier JSON de backup. Po»õi ulterior sƒÉ-l impor»õi folosind "ImportƒÉ Date din Fi»ôier".</p>
                        
                        <h4 style="margin-top: 20px;">√é: Ce se √Ænt√¢mplƒÉ dacƒÉ schimb browser-ul sau dispozitivul?</h4>
                        <p><strong>R:</strong> ExportƒÉ datele din browser-ul/dispozitivul original »ôi importƒÉ-le pe cel nou. Datele sunt stocate local per browser, nu √Æn cloud.</p>
                        
                        <h4 style="margin-top: 20px;">√é: Cum resetez totul?</h4>
                        <p><strong>R:</strong> √én tab-ul <strong>Date</strong>, folose»ôte butonul "»òterge Toate Datele". ‚ö†Ô∏è AsigurƒÉ-te cƒÉ expor»õi un backup mai √Ænt√¢i - aceastƒÉ ac»õiune nu poate fi anulatƒÉ!</p>
                    </div>

                    <div style="background: #e8ecff; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea;">
                        <p style="margin: 0;"><strong>üí° Sfat:</strong> Sistemul de clasare este conceput pentru a asigura echitate maximƒÉ. Ai √Æncredere √Æn algoritm - ia √Æn considerare toate datele istorice »ôi contextul sƒÉptƒÉm√¢nii curente pentru a face cele mai echitabile recomandƒÉri!</p>
                    </div>
                `
            };
            
            const container = document.getElementById('faqContainer');
            if (container) {
                container.innerHTML = faqContent[currentLang];
            }
        }
        
        // Initialize language toggle button
        document.addEventListener('DOMContentLoaded', function() {
            // Handle clicks on language options
            document.querySelectorAll('.lang-option').forEach(option => {
                option.addEventListener('click', function() {
                    const selectedLang = this.getAttribute('data-lang');
                    if (selectedLang !== currentLang) {
                        toggleLanguage();
                    }
                });
            });
            
            // Apply translations on initial load
            applyTranslations();
            
            // Generate FAQ content
            generateFAQ();
            
            // Note: generateSetup() is called in the main initialization after DB is ready
        });

    </script>
</body>
</html>
